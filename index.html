<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULATEUR DE PERFORMANCES</title>

  <!-- BULMA -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

  <!-- Overrides / styles spécifiques (KPI + impression + 2-3 ajustements) -->
  <style>
    :root{
      --ok:#16a34a;
      --bad:#dc2626;
      --warn-yellow-bg:#fff7ed; --warn-yellow-border:#fbbf24;
      --warn-red-bg:#fef2f2; --warn-red-border:#ef4444;
    }

    /* Espacements un peu plus "aérés" */
    .section { padding-top: 1.25rem; padding-bottom: 1.25rem; }

    /* Petits textes */
    .note{font-size:12px}
    .mini-note{font-size:11px}

    /* KPI */
    .kpi{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid #dbdbdb;border-radius:16px;padding:14px 16px;margin:8px 0;
      background:#fff;
    }
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:#6b7280;letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:#6b7280}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}

    /* Chips (statuts) */
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid #dbdbdb;font-weight:800;
      background:#f5f5f5; color:#363636;
      white-space:nowrap;
    }
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f5f5f5;color:#363636;border-color:#dbdbdb}

    /* Petites "cases" de résultat (vent face/travers/arrière + détails) */
    .fieldbox{
      border:1px solid #dbdbdb;border-radius:12px;background:#fafafa;padding:10px;
    }
    .fieldbox .k{font-size:12px;color:#6b7280}
    .fieldbox .v{margin-top:4px;font-weight:600;white-space:pre-line}

    /* Avertissements / invalid */
    .warn-yellow{background:var(--warn-yellow-bg)!important;border-color:var(--warn-yellow-border)!important}
    .warn-red{background:var(--warn-red-bg)!important;border-color:var(--warn-red-border)!important}
    .invalid{border-color:var(--bad)!important}

    /* Impression */
    #printRaw{display:none}
    .printWrap{
      color:#000;
      font:11pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .ptitle{
      background:#000; color:#fff; padding:8px 12px; border-radius:12px;
      display:inline-block; font-weight:700; margin:2mm 0 4mm 0;
    }
    .sectionPrint{margin:4mm 0}
    .kv{display:grid;grid-template-columns:42% 58%;gap:4px 8px;align-items:baseline}
    .kv .k{color:#374151}
    .kv .v{font-weight:600}
    .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px}
    .metar{
      background:#f7f7f7;border:1px solid #ddd;border-radius:8px;padding:8px;white-space:pre-wrap;word-break:break-word;font-size:10pt;
    }
    .b{font-weight:700}
    .page{page-break-after:always}
    .page:last-child{page-break-after:auto}

    @media print{
      @page { size: A4; margin: 12mm; }
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:0}
      body{background:#fff}
    }
  </style>
</head>

<body>
  <div id="appRoot">
    <!-- Bandeau -->
    <section class="hero is-link">
      <div class="hero-body">
        <div class="container">
          <h1 class="title has-text-centered">CALCULATEUR DE PERFORMANCES</h1>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">

        <!-- Paramètres généraux -->
        <div class="box">
          <h2 class="title is-5 has-text-centered">Paramètres généraux</h2>

          <div class="columns is-multiline">
            <div class="column is-6">
              <div class="field">
                <label class="label">Avion</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="aircraftSel">
                      <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
                      <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
                      <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
                      <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
                      <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
                      <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">Hélice</label>
                <div class="control">
                  <input id="propeller" class="input" value="Sensenich" readonly />
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">Marge sécurité (%)</label>
                <div class="control">
                  <input id="safety" class="input" type="number" inputmode="numeric" value="30" min="0"/>
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">&nbsp;</label>
                <div class="control">
                  <button id="btnPrint" class="button is-light is-fullwidth has-text-weight-bold">Imprimer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2 colonnes (dep/arr) -->
        <div class="columns is-variable is-4 is-multiline">

          <!-- Départ -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardDep">
              <h2 class="title is-5 has-text-centered">Terrain de départ</h2>

              <div class="columns is-mobile is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">ICAO départ</label>
                    <div class="control">
                      <input id="depIcao" class="input" inputmode="latin" maxlength="4" placeholder="LFxx" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Élévation (ft)</label>
                    <div class="control">
                      <input id="depAlt" class="input" type="number" inputmode="numeric" min="0" step="10" value="0" />
                    </div>
                  </div>
                </div>

                <div class="column is-4 is-flex is-align-items-flex-end">
                  <button id="btnDepMetar" class="button is-info is-fullwidth has-text-weight-bold is-small">Charger METAR</button>
                </div>
              </div>

              <div id="depMetarMsg" class="has-text-grey note"></div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">QFU départ (°)</label>
                    <div class="control">
                      <input id="depQfu" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001–360"/>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">TODA (m)</label>
                    <div class="control">
                      <input id="depToda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">ASDA (m)</label>
                    <div class="control">
                      <input id="depAsda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent — Direction (° ou "VRB")</label>
                    <div class="control">
                      <input id="depWindDir" class="input" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent — Vitesse (kt)</label>
                    <div class="control">
                      <input id="depWindKt" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Rafales (kt)</label>
                    <div class="control">
                      <input id="depWindGust" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-8">
                  <div class="field">
                    <label class="label">Secteur VRB (optionnel)</label>
                    <div class="control">
                      <div class="columns is-mobile is-variable is-1">
                        <div class="column">
                          <input id="depVrbFrom" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
                        </div>
                        <div class="column is-narrow is-flex is-align-items-center has-text-weight-bold has-text-grey">
                          V
                        </div>
                        <div class="column">
                          <input id="depVrbTo" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">OAT (°C)</label>
                    <div class="control">
                      <input id="depOat" class="input" type="number" inputmode="numeric" value="15"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent de face</div>
                    <div class="v"><span id="depHwFace">—</span> kt</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div id="depXwCard" class="fieldbox">
                    <div class="k">Vent de travers</div>
                    <div class="v" id="depXw">—</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent arrière</div>
                    <div class="v"><span id="depTw">—</span> kt</div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field has-text-centered">
                    <label class="label">Carénages de roues</label>
                    <div class="buttons is-centered">
                      <button id="spatsWith" class="button is-link is-light">Avec</button>
                      <button id="spatsWithout" class="button is-light">Sans</button>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field has-text-centered">
                    <label class="label">Surface piste</label>
                    <div class="buttons is-centered">
                      <button id="depSurfHard" class="button is-link is-light">Dur</button>
                      <button id="depSurfGrass" class="button is-success is-light">Herbe</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">Masse au décollage (kg)</label>
                    <div class="control">
                      <input id="depTow" class="input" type="number" inputmode="numeric" value="900"/>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field">
                    <label class="label">Facteur suppl. décollage</label>
                    <div class="control">
                      <input id="depExtraTO" class="input" type="number" inputmode="numeric" step="0.01" value="1.00"/>
                    </div>
                  </div>
                </div>
              </div>

              <button id="btnCalcDep" class="button is-link is-fullwidth mt-3">Calculer les performances décollage</button>
            </div>
          </div>

          <!-- Décollage perf -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardDepPerf">
              <div class="is-flex is-justify-content-space-between is-align-items-center">
                <h2 class="title is-5 has-text-centered" style="flex:1">Décollage : performances calculées</h2>
                <span id="toChip" class="chip neutral">—</span>
              </div>

              <div id="toKpi" class="kpi">
                <div class="left">
                  <span class="title">Requis (marge incluse)</span>
                  <span class="value" id="toKpiVal">— m</span>
                  <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
                </div>
              </div>

              <div class="columns is-multiline is-variable is-2">
                <div class="column is-6"><div class="fieldbox"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k" id="toResLabel">Résultat</div><div id="toRes" class="v">—</div></div></div>
              </div>

              <div id="toExplain" class="has-text-grey mini-note"></div>
            </div>
          </div>

          <!-- Arrivée -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardArr">
              <h2 class="title is-5 has-text-centered">Terrain d'arrivée</h2>

              <div class="columns is-mobile is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">ICAO arrivée</label>
                    <div class="control">
                      <input id="arrIcao" class="input" inputmode="latin" maxlength="4" placeholder="LFxx" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Élévation (ft)</label>
                    <div class="control">
                      <input id="arrAlt" class="input" type="number" inputmode="numeric" min="0" step="10" value="0" />
                    </div>
                  </div>
                </div>

                <div class="column is-4 is-flex is-align-items-flex-end">
                  <button id="btnArrMetar" class="button is-info is-fullwidth has-text-weight-bold is-small">Charger METAR</button>
                </div>
              </div>

              <div id="arrMetarMsg" class="has-text-grey note"></div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">QFU arrivée (°)</label>
                    <div class="control">
                      <input id="arrQfu" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001–360"/>
                    </div>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">LDA (m)</label>
                    <div class="control">
                      <input id="arrLda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent — Direction (° ou "VRB")</label>
                    <div class="control">
                      <input id="arrWindDir" class="input" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
                    </div>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent — Vitesse (kt)</label>
                    <div class="control">
                      <input id="arrWindKt" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Rafales (kt)</label>
                    <div class="control">
                      <input id="arrWindGust" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-8">
                  <div class="field">
                    <label class="label">Secteur VRB (optionnel)</label>
                    <div class="control">
                      <div class="columns is-mobile is-variable is-1">
                        <div class="column">
                          <input id="arrVrbFrom" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
                        </div>
                        <div class="column is-narrow is-flex is-align-items-center has-text-weight-bold has-text-grey">
                          V
                        </div>
                        <div class="column">
                          <input id="arrVrbTo" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">OAT (°C)</label>
                    <div class="control">
                      <input id="arrOat" class="input" type="number" inputmode="numeric" value="15"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent de face</div>
                    <div class="v"><span id="arrHwFace">—</span> kt</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div id="arrXwCard" class="fieldbox">
                    <div class="k">Vent de travers</div>
                    <div class="v" id="arrXw">—</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent arrière</div>
                    <div class="v"><span id="arrTw">—</span> kt</div>
                  </div>
                </div>
              </div>

              <div class="field has-text-centered">
                <label class="label">Type de freinage</label>
                <div class="buttons is-centered">
                  <button id="arrModerate" class="button is-link is-light">Freinage modéré (dur/herbe)</button>
                  <button id="arrNoBrake" class="button is-success is-light">Sans frein sur herbe</button>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">Masse à l'atterrissage (kg)</label>
                    <div class="control">
                      <input id="arrLdw" class="input" type="number" inputmode="numeric" value="900"/>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field">
                    <label class="label">Facteur suppl. atterrissage</label>
                    <div class="control">
                      <input id="arrExtraLDG" class="input" type="number" inputmode="numeric" step="0.01" value="1.00"/>
                    </div>
                  </div>
                </div>
              </div>

              <button id="btnCalcArr" class="button is-link is-fullwidth mt-3">Calculer les performances atterrissage</button>
            </div>
          </div>

          <!-- Atterrissage perf -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardArrPerf">
              <div class="is-flex is-justify-content-space-between is-align-items-center">
                <h2 class="title is-5 has-text-centered" style="flex:1">Atterrissage : performances calculées</h2>
                <span id="ldgChip" class="chip neutral">—</span>
              </div>

              <div id="ldgKpi" class="kpi">
                <div class="left">
                  <span class="title">Requis (marge incluse)</span>
                  <span class="value" id="ldgKpiVal">— m</span>
                  <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
                </div>
              </div>

              <div class="columns is-multiline is-variable is-2">
                <div class="column is-6"><div class="fieldbox"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div></div>
                <div class="column is-12"><div class="fieldbox"><div class="k" id="ldgResLabel">Résultat</div><div id="ldgRes" class="v">—</div></div></div>
              </div>

              <div id="ldgExplain" class="has-text-grey mini-note"></div>
            </div>
          </div>

        </div>

        <!-- Crédits -->
        <p class="has-text-grey has-text-centered" style="font-size:11px">
          <span>Source : Manuel de vol respectif de chaque avion - Aéroclub de Beauvais-Tillé</span><br>
          <span>Développé par Hugo DERUELLE avec l'aide de l'IA</span>
        </p>

      </div>
    </section>
  </div>

  <datalist id="dirOptions"><option value="VRB"></option></datalist>

  <!-- Impression -->
  <section id="printRaw"><div id="rawPre" class="printWrap"></div></section>

  <script>

  /* ===================== DONNÉES ===================== */
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,490,550]},kg900:{roll:[450,525,605],pass:[790,910,1030]}}},8000:{temps:{minus20:-20,isa:0,plus20:20},hard:{kg700:{roll:[245,285,335],pass:[520,600,700]},kg900:{roll:[430,510,610],pass:[900,1060,1250]}},grass:{kg700:{roll:[330,395,470],pass:[600,700,820]},kg900:{roll:[650,790,970],pass:[1100,1320,1560]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[170,180,195],pass:[420,445,480]},kg900:{roll:[265,280,300],pass:[625,660,705]}},grass:{kg700:{roll:[210,225,245],pass:[460,495,535]},kg900:{roll:[340,365,395],pass:[710,760,820]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[225,245,270],pass:[520,565,620]},kg900:{roll:[350,380,420],pass:[775,845,930]}},grass:{kg700:{roll:[280,315,350],pass:[590,655,720]},kg900:{roll:[460,525,585],pass:[900,1020,1140]}}},8000:{temps:{minus20:-20,isa:0,plus20:20},hard:{kg700:{roll:[320,365,410],pass:[710,805,910]},kg900:{roll:[500,580,670],pass:[1050,1210,1400]}},grass:{kg700:{roll:[420,490,560],pass:[820,960,1100]},kg900:{roll:[740,880,1040],pass:[1260,1510,1770]}}}};

  const propByAircraft={
    'F-GCAL (120cv)':'Sensenich',
    'F-BXEK (120cv)':'Sensenich',
    'F-BTKG (120cv)':'Sensenich',
    'F-BTXS (120cv)':'Sensenich',
    'F-BTBS (120cv)':'Sensenich',
    'F-BTBJ (108cv)':'Sensenich'
  };

  /* ===================== UTILITAIRES ===================== */
  function $(id){return document.getElementById(id);}
  function clamp(x,min,max){return Math.max(min,Math.min(max,x));}
  function round1(x){return Math.round(x*10)/10;}
  function round0(x){return Math.round(x);}

  function parseDir(v){
    v=(v||'').trim().toUpperCase();
    if(v==='VRB') return {vrb:true,dir:null};
    let n=parseInt(v,10);
    if(!isFinite(n)) return {vrb:false,dir:null};
    n=((n%360)+360)%360; if(n===0) n=360;
    return {vrb:false,dir:n};
  }
  function toRad(d){return d*Math.PI/180;}
  function wrap360(x){
    x=((x%360)+360)%360;
    if(x===0) x=360;
    return x;
  }

  /* ===================== ÉTAT ===================== */
  let withSpats=true;
  let depSurface='hard'; // hard|grass
  let landingMode='moderate'; // moderate|nobrake_grass

  /* ===================== UI : TOGGLES ===================== */
  $('#spatsWith').onclick=function(){
    withSpats=true;
    $('#spatsWith').classList.add('on');
    $('#spatsWithout').classList.remove('on');
  };
  $('#spatsWithout').onclick=function(){
    withSpats=false;
    $('#spatsWithout').classList.add('on');
    $('#spatsWith').classList.remove('on');
  };
  $('#depSurfHard').onclick=function(){
    depSurface='hard';
    $('#depSurfHard').classList.add('on');
    $('#depSurfGrass').classList.remove('on');
  };
  $('#depSurfGrass').onclick=function(){
    depSurface='grass';
    $('#depSurfGrass').classList.add('on');
    $('#depSurfHard').classList.remove('on');
  };
  $('#arrModerate').onclick=function(){
    landingMode='moderate';
    $('#arrModerate').classList.add('on');
    $('#arrNoBrake').classList.remove('on');
  };
  $('#arrNoBrake').onclick=function(){
    landingMode='nobrake_grass';
    $('#arrNoBrake').classList.add('on');
    $('#arrModerate').classList.remove('on');
  };

  /* ===================== MÉTÉO / METAR ===================== */
  async function fetchMetar(icao){
    icao=(icao||'').trim().toUpperCase();
    if(!icao || icao.length!==4) throw new Error('ICAO invalide');
    // API NOAA (ADDS)
    const url=`https://aviationweather.gov/api/data/metar?ids=${encodeURIComponent(icao)}&format=json`;
    const r=await fetch(url);
    if(!r.ok) throw new Error('METAR non dispo');
    const j=await r.json();
    if(!Array.isArray(j) || !j.length) throw new Error('METAR vide');
    return j[0];
  }

  function setMetarToUI(prefix, met){
    // met: objet NOAA JSON (champ rawOb, wdir, wspd, gust, temp, etc.)
    const raw=met.rawOb || met.raw || '';
    const wdir=met.wdir;
    const wspd=met.wspd;
    const gust=met.gust;
    const temp=met.temp;

    if(raw){
      $(`${prefix}MetarMsg`).textContent = raw;
    }else{
      $(`${prefix}MetarMsg`).textContent = 'METAR chargé';
    }

    // direction: si null -> VRB
    if(wdir==null){
      $(`${prefix}WindDir`).value='VRB';
    }else{
      $(`${prefix}WindDir`).value=String(wdir).padStart(3,'0');
    }
    if(wspd!=null) $(`${prefix}WindKt`).value = wspd;
    if(gust!=null) $(`${prefix}WindGust`).value = gust;
    if(temp!=null) $(`${prefix}Oat`).value = temp;

    updateWindDisplay(prefix);
  }

  $('#btnDepMetar').addEventListener('click', async()=>{
    try{
      $('#depMetarMsg').textContent='Chargement...';
      const icao=$('#depIcao').value;
      const m=await fetchMetar(icao);
      setMetarToUI('dep', m);
    }catch(e){
      $('#depMetarMsg').textContent=String(e.message||e);
    }
  });

  $('#btnArrMetar').addEventListener('click', async()=>{
    try{
      $('#arrMetarMsg').textContent='Chargement...';
      const icao=$('#arrIcao').value;
      const m=await fetchMetar(icao);
      setMetarToUI('arr', m);
    }catch(e){
      $('#arrMetarMsg').textContent=String(e.message||e);
    }
  });

  /* ===================== VENT : composantes ===================== */
  function windComponents(runwayQfu, windDir, windKt){
    // runwayQfu: degrés 1..360
    // windDir: degrés 1..360 (direction D'OÙ vient le vent)
    // retourne headwind (+), tailwind (+), crosswind (+ gauche / - droite)
    const r=wrap360(Number(runwayQfu)||0);
    const w=wrap360(Number(windDir)||0);
    const sp=Number(windKt)||0;

    // angle entre piste (direction du mouvement) et vent (direction d'où vient)
    // composante face: cos(angleDiff) * sp, mais attention: headwind positif si vent vient de l'avant.
    // Diff = windDir - runwayQfu
    const diff=toRad(w - r);
    const head = Math.cos(diff) * sp;       // + = vent de face
    const cross = Math.sin(diff) * sp;      // + = vent de gauche (convention)
    const tail = Math.max(0, -head);        // vent arrière positif
    const headpos = Math.max(0, head);

    return {head:round1(headpos), tail:round1(tail), cross:round1(cross)};
  }

  function parseVrbSector(prefix){
    const from=$(`${prefix}VrbFrom`)?.value?.trim();
    const to=$(`${prefix}VrbTo`)?.value?.trim();
    const f=parseInt(from,10), t=parseInt(to,10);
    if(!isFinite(f) || !isFinite(t)) return null;
    return {from:wrap360(f), to:wrap360(t)};
  }

  function validateVrbInputs(prefix){
    const fEl=$(`${prefix}VrbFrom`);
    const tEl=$(`${prefix}VrbTo`);
    if(!fEl || !tEl) return;
    fEl.classList.remove('invalid'); tEl.classList.remove('invalid');

    const f=fEl.value.trim(), t=tEl.value.trim();
    if((!f && !t) || (f && t)) return; // ok vide ou les deux remplis
    // sinon invalide
    fEl.classList.add('invalid'); tEl.classList.add('invalid');
  }

  function windInSector(dir, sector){
    // sector: {from,to} en degrés
    // gère le cas qui traverse 360
    if(!sector) return true;
    const d=wrap360(dir);
    const a=sector.from, b=sector.to;
    if(a<=b) return d>=a && d<=b;
    return d>=a || d<=b;
  }

  function updateWindDisplay(prefix){
    validateVrbInputs(prefix);

    const qfu=parseInt($(`${prefix}Qfu`).value,10);
    const wdirRaw=$(`${prefix}WindDir`).value;
    const wkt=Number($(`${prefix}WindKt`).value)||0;

    const parsed=parseDir(wdirRaw);
    const sector=parseVrbSector(prefix);

    if(!qfu || qfu<1 || qfu>360){
      $(`${prefix}HwFace`).textContent='—';
      $(`${prefix}Tw`).textContent='—';
      $(`${prefix}Xw`).textContent='—';
      return;
    }

    // si VRB, on affiche "VRB" et si secteur, on fait un min/max de composantes
    if(parsed.vrb){
      // si pas de secteur: pas calcul fiable
      if(!sector){
        $(`${prefix}HwFace`).textContent='—';
        $(`${prefix}Tw`).textContent='—';
        $(`${prefix}Xw`).textContent='VRB';
        return;
      }
      // balaye 360 pour trouver min/max composantes dans le secteur
      let maxHead=0, maxTail=0, maxCross=0;
      let maxCrossDir=null;

      for(let d=1; d<=360; d++){
        if(!windInSector(d, sector)) continue;
        const c=windComponents(qfu,d,wkt);
        maxHead=Math.max(maxHead,c.head);
        maxTail=Math.max(maxTail,c.tail);
        if(Math.abs(c.cross)>maxCross){
          maxCross=Math.abs(c.cross);
          maxCrossDir=c.cross;
        }
      }
      $(`${prefix}HwFace`).textContent=round1(maxHead);
      $(`${prefix}Tw`).textContent=round1(maxTail);

      const side = (maxCrossDir==null) ? '' : (maxCrossDir>0 ? ' (G)' : ' (D)');
      $(`${prefix}Xw`).textContent=round1(maxCross) + ' kt' + side;

      // couleur travers
      const card=$(`${prefix}XwCard`);
      if(card){
        card.classList.remove('warn-yellow','warn-red');
        const xwForColor = maxCross;
        if(xwForColor>=22){ card.classList.add('warn-red'); }
        else if(xwForColor>=18){ card.classList.add('warn-yellow'); }
      }
      return;
    }

    // direction fixe
    if(parsed.dir==null){
      $(`${prefix}HwFace`).textContent='—';
      $(`${prefix}Tw`).textContent='—';
      $(`${prefix}Xw`).textContent='—';
      return;
    }
    const c=windComponents(qfu, parsed.dir, wkt);
    $(`${prefix}HwFace`).textContent=c.head;
    $(`${prefix}Tw`).textContent=c.tail;

    const side = (c.cross>0 ? ' (G)' : (c.cross<0 ? ' (D)' : ''));
    $(`${prefix}Xw`).textContent=Math.abs(c.cross)+' kt'+side;

    // couleur travers
    const card=$(`${prefix}XwCard`);
    if(card){
      card.classList.remove('warn-yellow','warn-red');
      const xwForColor = Math.abs(c.cross);
      if(xwForColor>=22){ card.classList.add('warn-red'); }
      else if(xwForColor>=18){ card.classList.add('warn-yellow'); }
    }
  }

  // listeners vent
  ['dep','arr'].forEach(prefix=>{
    ['Qfu','WindDir','WindKt','VrbFrom','VrbTo'].forEach(s=>{
      const el=$(`${prefix}${s}`);
      if(el) el.addEventListener('input', ()=>updateWindDisplay(prefix));
    });
  });

  /* ===================== INTERPOLATIONS PERF ===================== */
  function lerp(a,b,t){return a+(b-a)*t;}
  function interp3(x, x0,x1,x2, y0,y1,y2){
    if(x<=x0) return y0;
    if(x>=x2) return y2;
    if(x<=x1){
      const t=(x-x0)/(x1-x0);
      return lerp(y0,y1,t);
    }else{
      const t=(x-x1)/(x2-x1);
      return lerp(y1,y2,t);
    }
  }

  function pickAltTable(data, altFt){
    // alt points: 0,4000,8000
    if(altFt<=0) return {a0:0,a1:0,t:0};
    if(altFt>=8000) return {a0:8000,a1:8000,t:0};
    if(altFt<=4000){
      return {a0:0,a1:4000,t:(altFt-0)/(4000-0)};
    }
    return {a0:4000,a1:8000,t:(altFt-4000)/(8000-4000)};
  }

  function weightKey(kg){
    // 700/900 (les tableaux ont kg700/kg900)
    return (kg<=700)?'kg700':'kg900';
  }
  function weightBlend(kg){
    if(kg<=700) return {w0:700,w1:700,t:0};
    if(kg>=900) return {w0:900,w1:900,t:0};
    return {w0:700,w1:900,t:(kg-700)/(900-700)};
  }

  function tempTriplet(altBlock){
    // altBlock.temps: minus20, isa, plus20 (valeurs en °C)
    return [altBlock.temps.minus20, altBlock.temps.isa, altBlock.temps.plus20];
  }

  function perfAtAlt(dataAltBlock, surface, kg, oat, mode){
    // mode: 'roll'/'pass'
    const s=dataAltBlock[surface];
    const wb=weightBlend(kg);
    const tpts=tempTriplet(dataAltBlock);

    function getForWeight(w){
      const key=(w<=700)?'kg700':'kg900';
      const arr=s[key][mode];
      return interp3(oat, tpts[0], tpts[1], tpts[2], arr[0], arr[1], arr[2]);
    }
    const y0=getForWeight(wb.w0);
    const y1=getForWeight(wb.w1);
    return lerp(y0,y1,wb.t);
  }

  function perfBase(data, altFt, surface, kg, oat, mode){
    const ab=pickAltTable(data,altFt);
    const p0=perfAtAlt(data[ab.a0], surface, kg, oat, mode);
    const p1=perfAtAlt(data[ab.a1], surface, kg, oat, mode);
    return lerp(p0,p1,ab.t);
  }

  /* ===================== FACTEURS ===================== */
  function windFactorTO(head, tail){
    // simplifié : TO : +10% par 2kt arrière / -5% par 2kt face
    // (tu peux ajuster si tu as une table réelle)
    let f=1.0;
    f *= (1 + 0.10*(tail/2));
    f *= (1 - 0.05*(head/2));
    return clamp(f, 0.6, 2.5);
  }
  function windFactorLDG(head, tail){
    // LDG : +10% par 2kt arrière / -5% par 2kt face
    let f=1.0;
    f *= (1 + 0.10*(tail/2));
    f *= (1 - 0.05*(head/2));
    return clamp(f, 0.6, 2.5);
  }

  function updateResLabels(){
    // rien ici dans ta version, gardé pour compat
  }

  /* ===================== CALCUL DÉCOLLAGE ===================== */
  function calcTakeoff(){
    const alt=Number($('#depAlt').value)||0;
    const qfu=parseInt($('#depQfu').value,10);
    const toda=parseInt($('#depToda').value,10);
    const safety=Number($('#safety').value)||0;
    const kg=Number($('#depTow').value)||900;
    const oat=Number($('#depOat').value)||15;
    const extra=Number($('#depExtraTO').value)||1.0;

    const wdir=parseDir($('#depWindDir').value);
    const wkt=Number($('#depWindKt').value)||0;

    if(!qfu || !toda){
      $('#toExplain').textContent='QFU/TODA manquants';
      return;
    }

    let head=0, tail=0;
    if(wdir.vrb){
      // si VRB sans secteur -> 0 par défaut
      const sector=parseVrbSector('dep');
      if(sector){
        let maxHead=0, maxTail=0;
        for(let d=1; d<=360; d++){
          if(!windInSector(d, sector)) continue;
          const c=windComponents(qfu,d,wkt);
          maxHead=Math.max(maxHead,c.head);
          maxTail=Math.max(maxTail,c.tail);
        }
        head=maxHead; tail=maxTail;
      }
    }else if(wdir.dir!=null){
      const c=windComponents(qfu,wdir.dir,wkt);
      head=c.head; tail=c.tail;
    }

    const surf = (depSurface==='grass') ? 'grass' : 'hard';

    const baseRoll = perfBase(TO_DR400, alt, surf, kg, oat, 'roll');
    const basePass = perfBase(TO_DR400, alt, surf, kg, oat, 'pass');

    let windF = windFactorTO(head, tail);
    let spatsF = withSpats ? 1.0 : 1.03;

    const resRoll = baseRoll * windF * spatsF * extra;
    const resPass = basePass * windF * spatsF * extra;

    const required = Math.max(resRoll, resPass) * (1 + safety/100);

    $('#toBaseRoll').textContent = round0(baseRoll) + ' m';
    $('#toBasePass').textContent = round0(basePass) + ' m';
    $('#toWindF').textContent = round1(windF);
    $('#toSpat').textContent = withSpats ? 'Avec carénages' : 'Sans carénages (+3% TO)';
    $('#toExtra').textContent = round1(extra);
    $('#toRes').textContent = 'Roulement: '+round0(resRoll)+' m | 15m: '+round0(resPass)+' m';

    $('#toKpiVal').textContent = round0(required) + ' m';
    $('#todaMini').textContent = toda + ' m';

    const ok = (required <= toda);
    const chip=$('#toChip');
    chip.textContent = ok ? 'OK' : 'NON';
    chip.className = 'chip ' + (ok ? 'ok' : 'bad');

    const kpi=$('#toKpi');
    kpi.classList.remove('ok','bad');
    kpi.classList.add(ok?'ok':'bad');

    $('#toExplain').textContent =
      `Vent pris en compte: face ${head} kt / arrière ${tail} kt. Surface: ${surf}.`;
  }

  $('#btnCalcDep').addEventListener('click', calcTakeoff);

  /* ===================== CALCUL ATTERRISSAGE ===================== */
  function calcLanding(){
    const alt=Number($('#arrAlt').value)||0;
    const qfu=parseInt($('#arrQfu').value,10);
    const lda=parseInt($('#arrLda').value,10);
    const safety=Number($('#safety').value)||0;
    const kg=Number($('#arrLdw').value)||900;
    const oat=Number($('#arrOat').value)||15;
    const extra=Number($('#arrExtraLDG').value)||1.0;

    const wdir=parseDir($('#arrWindDir').value);
    const wkt=Number($('#arrWindKt').value)||0;

    if(!qfu || !lda){
      $('#ldgExplain').textContent='QFU/LDA manquants';
      return;
    }

    let head=0, tail=0;
    if(wdir.vrb){
      const sector=parseVrbSector('arr');
      if(sector){
        let maxHead=0, maxTail=0;
        for(let d=1; d<=360; d++){
          if(!windInSector(d, sector)) continue;
          const c=windComponents(qfu,d,wkt);
          maxHead=Math.max(maxHead,c.head);
          maxTail=Math.max(maxTail,c.tail);
        }
        head=maxHead; tail=maxTail;
      }
    }else if(wdir.dir!=null){
      const c=windComponents(qfu,wdir.dir,wkt);
      head=c.head; tail=c.tail;
    }

    // surface landing dépend du mode
    const surf = (landingMode==='nobrake_grass') ? 'grass' : 'hard';

    const baseRoll = perfBase(LDG_DR400, alt, surf, kg, oat, 'roll');
    const basePass = perfBase(LDG_DR400, alt, surf, kg, oat, 'pass');

    let windF = windFactorLDG(head, tail);
    const resRoll = baseRoll * windF * extra;
    const resPass = basePass * windF * extra;

    const required = Math.max(resRoll, resPass) * (1 + safety/100);

    $('#ldgBaseRoll').textContent = round0(baseRoll) + ' m';
    $('#ldgBasePass').textContent = round0(basePass) + ' m';
    $('#ldgWindF').textContent = round1(windF);
    $('#ldgExtra').textContent = round1(extra);
    $('#ldgRes').textContent = 'Roulement: '+round0(resRoll)+' m | 15m: '+round0(resPass)+' m';

    $('#ldgKpiVal').textContent = round0(required) + ' m';
    $('#ldaMini').textContent = lda + ' m';

    const ok = (required <= lda);
    const chip=$('#ldgChip');
    chip.textContent = ok ? 'OK' : 'NON';
    chip.className = 'chip ' + (ok ? 'ok' : 'bad');

    const kpi=$('#ldgKpi');
    kpi.classList.remove('ok','bad');
    kpi.classList.add(ok?'ok':'bad');

    $('#ldgExplain').textContent =
      `Vent pris en compte: face ${head} kt / arrière ${tail} kt. Surface: ${surf}.`;
  }

  $('#btnCalcArr').addEventListener('click', calcLanding);

  /* ===================== CHANGEMENT AVION ===================== */
  $('#aircraftSel').addEventListener('change', ()=>{
    const ac=$('#aircraftSel').value;
    $('#propeller').value = propByAircraft[ac] || '';
  });

  /* ===================== IMPRESSION ===================== */
  function sectionInputsHTML(title, prefix){
    const icao=$(`${prefix}Icao`).value||'—';
    const alt=$(`${prefix}Alt`).value||'—';
    const qfu=$(`${prefix}Qfu`).value||'—';
    const windDir=$(`${prefix}WindDir`).value||'—';
    const windKt=$(`${prefix}WindKt`).value||'—';
    const gust=$(`${prefix}WindGust`).value||'—';
    const oat=$(`${prefix}Oat`).value||'—';
    const from=$(`${prefix}VrbFrom`).value||'';
    const to=$(`${prefix}VrbTo`).value||'';
    const sector = (from && to) ? `${from}V${to}` : '—';

    let runwayDistLabel='—', runwayDistVal='—';
    if(prefix==='dep'){ runwayDistLabel='TODA'; runwayDistVal=$('#depToda').value||'—'; }
    if(prefix==='arr'){ runwayDistLabel='LDA'; runwayDistVal=$('#arrLda').value||'—'; }

    return `
      <div class="sectionPrint">
        <div class="ptitle">${title}</div>
        <div class="kv">
          <div class="k">ICAO</div><div class="v">${icao}</div>
          <div class="k">Élévation</div><div class="v">${alt} ft</div>
          <div class="k">QFU</div><div class="v">${qfu}°</div>
          <div class="k">${runwayDistLabel}</div><div class="v">${runwayDistVal} m</div>
          <div class="k">Vent</div><div class="v">${windDir}° / ${windKt} kt (G ${gust})</div>
          <div class="k">Secteur VRB</div><div class="v">${sector}</div>
          <div class="k">OAT</div><div class="v">${oat} °C</div>
        </div>
      </div>
    `;
  }

  function sectionPerfHTML(title, which){
    if(which==='dep'){
      return `
        <div class="sectionPrint">
          <div class="ptitle">${title}</div>
          <div class="kv">
            <div class="k">Requis (marge incluse)</div><div class="v">${$('#toKpiVal').textContent}</div>
            <div class="k">TODA dispo</div><div class="v">${$('#todaMini').textContent}</div>
            <div class="k">Roulement (sans marge)</div><div class="v">${$('#toBaseRoll').textContent}</div>
            <div class="k">15m (sans marge)</div><div class="v">${$('#toBasePass').textContent}</div>
            <div class="k">Facteur vent</div><div class="v">${$('#toWindF').textContent}</div>
            <div class="k">Carénages</div><div class="v">${$('#toSpat').textContent}</div>
            <div class="k">Facteur suppl.</div><div class="v">${$('#toExtra').textContent}</div>
            <div class="k">Résultat</div><div class="v">${$('#toRes').textContent}</div>
          </div>
          <div class="metar">${($('#depMetarMsg').textContent||'').trim()}</div>
        </div>
      `;
    }else{
      return `
        <div class="sectionPrint">
          <div class="ptitle">${title}</div>
          <div class="kv">
            <div class="k">Requis (marge incluse)</div><div class="v">${$('#ldgKpiVal').textContent}</div>
            <div class="k">LDA dispo</div><div class="v">${$('#ldaMini').textContent}</div>
            <div class="k">Roulement (sans marge)</div><div class="v">${$('#ldgBaseRoll').textContent}</div>
            <div class="k">15m (sans marge)</div><div class="v">${$('#ldgBasePass').textContent}</div>
            <div class="k">Facteur vent</div><div class="v">${$('#ldgWindF').textContent}</div>
            <div class="k">Facteur suppl.</div><div class="v">${$('#ldgExtra').textContent}</div>
            <div class="k">Résultat</div><div class="v">${$('#ldgRes').textContent}</div>
          </div>
          <div class="metar">${($('#arrMetarMsg').textContent||'').trim()}</div>
        </div>
      `;
    }
  }

  function buildPrintHTML(){
    const safety=$('#safety').value||'—';
    const ac=$('#aircraftSel').value||'—';
    const prop=$('#propeller').value||'—';
    const dateStr = new Date().toLocaleString('fr-FR');

    const page1 = `
      <div class="page">
        <div class="ptitle">CALCULATEUR DE PERFORMANCES</div>
        <div class="sectionPrint">
          <div class="kv">
            <div class="k">Date / heure</div><div class="v">${dateStr}</div>
            <div class="k">Avion</div><div class="v">${ac}</div>
            <div class="k">Hélice</div><div class="v">${prop}</div>
            <div class="k">Marge sécurité</div><div class="v">${safety} %</div>
          </div>
        </div>
        ${sectionInputsHTML('Départ — Entrées', 'dep')}
        ${sectionPerfHTML('Décollage — Résultats', 'dep')}
      </div>
    `;

    const page2 = `
      <div class="page">
        ${sectionInputsHTML('Arrivée — Entrées', 'arr')}
        ${sectionPerfHTML('Atterrissage — Résultats', 'arr')}
      </div>
    `;

    return page1 + page2;
  }

  document.getElementById('btnPrint').addEventListener('click',function(){
    document.getElementById('rawPre').innerHTML = buildPrintHTML();
    window.print();
  });

  // init
  (function init(){
    var ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    updateWindDisplay('dep');
    updateWindDisplay('arr');
    updateResLabels();
  })();
</script>
</body>
</html>
