<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULCATEUR DE PERFORMANCES</title>
  <style>
    :root{
      --bg:#e9ecf3; --card:#fff; --ink:#0f172a; --muted:#6b7280;
      --ok:#16a34a; --bad:#dc2626;
      --line:#d1d5db; --primary:#0b3b86; --primaryText:#ffffff; --green:#16a34a;
      --warn-yellow-bg:#fff7ed; --warn-yellow-border:#fbbf24;
      --warn-red-bg:#fef2f2; --warn-red-border:#ef4444;
      --banner:#081a4f; --btnGrey:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}

    .banner{
      background:var(--primary);color:var(--primaryText);
      padding:14px 16px;margin:0 0 12px 0;border-radius:16px;
    }
    .banner h1{font-size:clamp(22px,3.5vw,30px);margin:0;text-align:center;letter-spacing:.02em}

    h2{font-size:18px;margin:0 0 .6rem 0}
    .container{max-width:1200px;margin:0 auto;padding:16px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .card>h2{ text-align:center } /* titres centrés */

    input, select, button.btn{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      padding:10px 12px;
      min-height:44px;
      line-height:1.2;
      -webkit-appearance:none; appearance:none;
      font:inherit;
    }
    select{background-image:none}
    .btn{cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.grey{background:var(--btnGrey);border-color:var(--line);color:var(--ink); font-weight:700;} /* imprimer en gras */
    .btn.metar{font-weight:700; font-size:.9em;} /* gras + légèrement plus petit */
    .btn.toggle.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.toggle.on.grass{background:var(--green)!important;border-color:var(--green)!important;color:#fff!important}
    .btn.block{display:block;width:100%;text-align:center}

    label{display:block;font-size:12px;color:var(--muted)}
    .inline{display:flex;gap:8px;align-items:flex-end}
    .inline > label{flex:1}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

    .rowline{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;margin-top:10px}
    .rowline .group{display:flex;flex-direction:column;gap:8px;flex-basis:48%;align-items:center}
    .group .buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .group.centered>label{text-align:center}

    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .note{font-size:12px;margin-top:6px}
    .mini-note{font-size:11px}

    .kpi{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin:8px 0}
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid;font-weight:800}
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb}

    .field{border:1px solid var(--line);border-radius:12px;background:#f8fafc;padding:10px}
    .field .k{font-size:12px;color:var(--muted)}
    .field .v{margin-top:4px;font-weight:600;white-space:pre-line}

    .warn-yellow{background:var(--warn-yellow-bg)!important;border-color:var(--warn-yellow-border)!important}
    .warn-red{background:var(--warn-red-bg)!important;border-color:var(--warn-red-border)!important}
    .invalid{border-color:var(--bad)!important}

    /* Grille principale */
    .gridAll{
      display:grid; gap:16px; grid-template-columns:1fr;
      grid-template-areas:"dep" "depperf" "arr" "arrperf";
    }
    #cardDep{grid-area:dep}
    #cardDepPerf{grid-area:depperf}
    #cardArr{grid-area:arr}
    #cardArrPerf{grid-area:arrperf}
    @media(min-width:768px){
      .gridAll{
        grid-template-columns:1fr 1fr;
        grid-template-areas:"dep arr" "depperf arrperf";
      }
    }

    /* Impression */
    #printRaw{display:none}
    .printWrap{
      color:#000;
      font:11pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .ptitle{
      background:#000; color:#fff; padding:8px 12px; border-radius:12px;
      display:inline-block; font-weight:700; margin:2mm 0 4mm 0;
    }
    .section{margin:4mm 0}
    .kv{display:grid;grid-template-columns:42% 58%;gap:4px 8px;align-items:baseline}
    .kv .k{color:#374151}
    .kv .v{font-weight:600}
    .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px}
    .metar{
      background:#f7f7f7;border:1px solid #ddd;border-radius:8px;padding:8px;white-space:pre-wrap;word-break:break-word;font-size:10pt;
    }
    .b{font-weight:700}

    .page{page-break-after:always}
    .page:last-child{page-break-after:auto}

    @media print{
      @page { size: A4; margin: 12mm; }
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:0}
      body{background:#fff}
    }
  </style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="banner">
    <h1>CALCULCATEUR DE PERFORMANCES</h1>
  </div>

  <section class="card" style="margin-top:4px">
    <h2>Paramètres généraux</h2>
    <div class="grid2">
      <!-- Ligne 1 -->
      <label>Avion
        <select id="aircraftSel">
          <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
          <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
          <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
          <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
          <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
          <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
        </select>
      </label>
      <label>Hélice
        <input id="propeller" value="Sensenich" readonly />
      </label>
      <!-- Ligne 2 : alignement print -->
      <label>Marge sécurité (%)
        <input id="safety" type="number" inputmode="numeric" value="30" min="0"/>
      </label>
      <label>&nbsp;
        <button id="btnPrint" class="btn grey">Imprimer</button>
      </label>
    </div>
  </section>

  <div class="gridAll" style="margin-top:12px">
    <!-- Départ -->
    <section class="card" id="cardDep">
      <h2>Terrain de départ</h2>
      <div class="inline">
        <label style="flex:0.6">ICAO départ
          <input id="depIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label style="flex:0.6">Élévation (ft)
          <input id="depAlt" type="number" inputmode="numeric" min="0" step="10" value="0" />
        </label>
        <button id="btnDepMetar" class="btn metar" style="flex:0.4">Charger METAR</button>
      </div>
      <div id="depMetarMsg" class="muted note"></div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU départ (°)
          <input id="depQfu" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001–360"/>
        </label>
        <label>TODA (m)
          <input id="depToda" type="text" inputmode="numeric" pattern="[0-9]*" />
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="depWindDir" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="depWindKt" type="number" inputmode="numeric" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="depWindGust" type="number" inputmode="numeric" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Secteur VRB (optionnel)
          <div class="vrbFlex" style="display:flex;gap:8px;align-items:center">
            <input id="depVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
            <span class="vrbSep" style="font-weight:700;color:#6b7280">V</span>
            <input id="depVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
          </div>
        </label>
        <label>OAT (°C)
          <input id="depOat" type="number" inputmode="numeric" value="15"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="depHwFace">—</span> kt</div></div>
        <div id="depXwCard" class="field">
          <div class="k">Vent de travers</div>
          <div class="v" id="depXw">—</div>
        </div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="depTw">—</span> kt</div></div>
      </div>

      <div class="rowline">
        <div class="group centered">
          <label>Carénages de roues</label>
          <div class="buttons">
            <button id="spatsWith" class="btn toggle on">Avec</button>
            <button id="spatsWithout" class="btn toggle">Sans</button>
          </div>
        </div>
        <div class="group centered">
          <label>Surface piste</label>
          <div class="buttons">
            <button id="depSurfHard" class="btn toggle on">Dur</button>
            <button id="depSurfGrass" class="btn toggle grass">Herbe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse au décollage (kg)
          <input id="depTow" type="number" inputmode="numeric" value="900"/>
        </label>
        <label>Facteur suppl. décollage
          <input id="depExtraTO" type="number" inputmode="numeric" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcDep" class="btn primary block" style="margin-top:14px">Calculer les performances décollage</button>
    </section>

    <!-- Décollage : performances -->
    <section class="card" id="cardDepPerf">
      <div class="header">
        <h2 style="width:100%; text-align:center">Décollage : performances calculées</h2>
        <span id="toChip" class="chip neutral">—</span>
      </div>
      <div id="toKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="toKpiVal">— m</span>
          <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div>
        <div class="field"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div>
        <div class="field"><div class="k" id="toResLabel">Résultat</div><div id="toRes" class="v">—</div></div>
      </div>
      <div id="toExplain" class="muted mini-note"></div>
    </section>

    <!-- Arrivée -->
    <section class="card" id="cardArr">
      <h2>Terrain d'arrivée</h2>
      <div class="inline">
        <label style="flex:0.6">ICAO arrivée
          <input id="arrIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label style="flex:0.6">Élévation (ft)
          <input id="arrAlt" type="number" inputmode="numeric" min="0" step="10" value="0" />
        </label>
        <button id="btnArrMetar" class="btn metar" style="flex:0.4">Charger METAR</button>
      </div>
      <div id="arrMetarMsg" class="muted note"></div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU arrivée (°)
          <input id="arrQfu" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001–360"/>
        </label>
        <label>LDA (m)
          <input id="arrLda" type="text" inputmode="numeric" pattern="[0-9]*" />
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="arrWindDir" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="arrWindKt" type="number" inputmode="numeric" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="arrWindGust" type="number" inputmode="numeric" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Secteur VRB (optionnel)
          <div class="vrbFlex" style="display:flex;gap:8px;align-items:center">
            <input id="arrVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
            <span class="vrbSep" style="font-weight:700;color:#6b7280">V</span>
            <input id="arrVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
          </div>
        </label>
        <label>OAT (°C)
          <input id="arrOat" type="number" inputmode="numeric" value="15"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="arrHwFace">—</span> kt</div></div>
        <div id="arrXwCard" class="field">
          <div class="k">Vent de travers</div>
          <div class="v" id="arrXw">—</div>
        </div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="arrTw">—</span> kt</div></div>
      </div>

      <div class="grid1" style="margin-top:10px">
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
          <label>Type de freinage</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <button id="arrModerate" class="btn toggle on">Freinage modéré (dur/herbe)</button>
            <button id="arrNoBrake" class="btn toggle grass">Sans frein sur herbe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse à l'atterrissage (kg)
          <input id="arrLdw" type="number" inputmode="numeric" value="900"/>
        </label>
        <label>Facteur suppl. atterrissage
          <input id="arrExtraLDG" type="number" inputmode="numeric" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcArr" class="btn primary block" style="margin-top:14px">Calculer les performances atterrissage</button>
    </section>

    <!-- Atterrissage : performances -->
    <section class="card" id="cardArrPerf">
      <div class="header">
        <h2 style="width:100%; text-align:center">Atterrissage : performances calculées</h2>
        <span id="ldgChip" class="chip neutral">—</span>
      </div>
      <div id="ldgKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="ldgKpiVal">— m</span>
          <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div>
        <div class="field"><div class="k" id="ldgResLabel">Résultat</div><div id="ldgRes" class="v">—</div></div>
      </div>
      <div id="ldgExplain" class="muted mini-note"></div>
    </section>
  </div>

  <!-- Crédits (web seulement) -->
  <div class="muted" style="margin-top:12px;font-size:11px; text-align:center">
    <div>Source : Manuel de vol respectif de chaque avion - Aéroclub de Beauvais-Tillé</div>
    <div>Développé par Hugo DERUELLE avec l'aide de l'IA</div>
  </div>
</div>

<datalist id="dirOptions"><option value="VRB"></option></datalist>

<!-- Impression -->
<section id="printRaw"><div id="rawPre" class="printWrap"></div></section>

<script>
  /* ===================== DONNÉES ===================== */
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,485,540]},kg900:{roll:[460,530,615],pass:[800,905,1025]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},hard:{kg700:{roll:[235,265,300],pass:[500,560,620]},kg900:{roll:[425,475,535],pass:[890,1000,1125]}},grass:{kg700:{roll:[330,380,440],pass:[595,675,760]},kg900:{roll:[700,820,960],pass:[1165,1350,1550]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},moderate:{kg700:{roll:[145,155,165],pass:[365,385,400]},kg900:{roll:[185,200,210],pass:[435,460,485]}},nobrake_grass:{kg700:{roll:[215,230,250],pass:[435,460,485]},kg900:{roll:[280,300,325],pass:[530,560,590]} }},4000:{temps:{minus20:-13,isa:7,plus20:27},moderate:{kg700:{roll:[160,175,185],pass:[395,420,440]},kg900:{roll:[205,225,240],pass:[475,505,535]}},nobrake_grass:{kg700:{roll:[240,260,285],pass:[475,505,530]},kg900:{roll:[310,335,360],pass:[580,615,655]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},moderate:{kg700:{roll:[180,195,210],pass:[430,460,485]},kg900:{roll:[235,250,270],pass:[525,555,590]}},nobrake_grass:{kg700:{roll:[275,290,315],pass:[525,555,590]},kg900:{roll:[350,375,405],pass:[640,680,725]}}}};
  const DR300_TEMPS=[0,15,30,45];
  const TO_DR300 = {
    hard: { alts:[0,1500,3000,4500],
      roll: [[315,350,390,430],[330,360,400,460],[385,430,475,520],[430,480,520,560]],
      pass: [[530,590,655,720],[605,675,745,820],[685,765,845,920],[760,845,935,1020]],
    },
    grass: { alts:[0,1500,3000,4600],
      roll: [[380,420,470,515],[420,470,515,575],[455,510,570,625],[510,575,635,695]],
      pass: [[595,660,735,805],[675,745,820,895],[760,850,935,1025],[845,940,1040,1135]],
    },
    massScale: function(m){ return Math.min(1, m/1000); }
  };

  /* ===================== UTILITAIRES ===================== */
  var $=function(s){return document.querySelector(s)};
  function lerp(x0,y0,x1,y1,x){ return y0 + (y1-y0)*((x-x0)/(x1-x0 || 1)); }
  function pad3(n){ return String(Math.round(n)).padStart(3,'0'); }
  function clamp01(v){ return Math.max(0,Math.min(1,v)); }
  function toRad(d){ return d*Math.PI/180; }
  function cosd(d){ return Math.cos(toRad(d)); }
  function sind(d){ return Math.sin(toRad(d)); }

  /* ===================== ÉTAT / UI ===================== */
  var landingMode='moderate', withSpats=true, profile='DR400', depSurface='hard';
  var lastDepMetarRaw='—', lastArrMetarRaw='—';

  var propByAircraft={'F-GCAL (120cv)':'Sensenich','F-BXEK (120cv)':'Sensenich','F-BTKG (120cv)':'Sensenich','F-BTXS (120cv)':'Sensenich','F-BTBS (120cv)':'Mac Cauley','F-BTBJ (108cv)':'Mac Cauley'};
  $('#aircraftSel').addEventListener('change', function(){
    var ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    profile=(ac.indexOf('F-BTKG')===0 || ac.indexOf('F-BTXS')===0)?'DR300':'DR400';
    updateWindDisplay('dep'); updateWindDisplay('arr');
  });

  // carénages / surfaces / freinage
  $('#spatsWith').onclick=function(){withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');};
  $('#spatsWithout').onclick=function(){withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');};
  $('#depSurfHard').onclick=function(){depSurface='hard';$('#depSurfHard').classList.add('on');$('#depSurfGrass').classList.remove('on');};
  $('#depSurfGrass').onclick=function(){depSurface='grass';$('#depSurfGrass').classList.add('on');$('#depSurfHard').classList.remove('on');};
  $('#arrModerate').onclick=function(){landingMode='moderate';$('#arrModerate').classList.add('on');$('#arrNoBrake').classList.remove('on');};
  $('#arrNoBrake').onclick=function(){landingMode='nobrake_grass';$('#arrNoBrake').classList.add('on');$('#arrModerate').classList.remove('on');};

  // safety
  function updateResLabels(){
    var s = Math.max(0, parseFloat($('#safety').value||'0')||0);
    $('#safety').value = String(s);
  }
  $('#safety').addEventListener('input', updateResLabels); updateResLabels();

  function sanitizeIcao(el){ el.value=(el.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,4) }
  ;['depIcao','arrIcao'].forEach(function(id){
    var el=$('#'+id);
    el.addEventListener('input',function(){sanitizeIcao(el)});
    el.addEventListener('blur',function(){sanitizeIcao(el)});
  });

  // QFU
  function normQFU(val){ var n=parseInt(String(val).replace(/\D/g,''),10); if(isNaN(n)) return null; n=Math.max(1,Math.min(360,n)); return n; }
  function display3(n){ return n===null?'':pad3(n); }
  ;['depQfu','arrQfu'].forEach(function(id){
    var el=$('#'+id);
    el.addEventListener('blur',function(){ var n=normQFU(el.value); el.value=display3(n); updateWindDisplay(id.indexOf('dep')===0?'dep':'arr'); });
    el.addEventListener('input',function(){ updateWindDisplay(id.indexOf('dep')===0?'dep':'arr'); });
  });

  // TODA/LDA
  $('#depToda').addEventListener('input',function(){ var s=$('#depToda').value.replace(/\D/g,''); if(s==='') return; var v=parseInt(s,10); if(!isFinite(v)||v<0)v=0; $('#depToda').value=String(v); });
  $('#arrLda').addEventListener('input',function(){ var s=$('#arrLda').value.replace(/\D/g,'').slice(0,4); $('#arrLda').value=s; });

  /* ===================== METAR (AVWX) ===================== */
  var AVWX_TOKEN='q45JCSdkFjeZqHUyvawV2iaFm80CYmlPP6kC3XS8VNs';
  function fetchJson(url){
    return fetch(url, { headers:{ Authorization:'Bearer '+AVWX_TOKEN, Accept:'application/json' } })
      .then(function(resp){ if(!resp.ok) throw new Error('HTTP '+resp.status); return resp.json(); });
  }
  function fetchMetar(icao){ return fetchJson('https://avwx.rest/api/metar/'+icao); }
  function fetchStation(icao){ return fetchJson('https://avwx.rest/api/station/'+icao); }
  function fetchNearestMetarByCoords(lat, lon){
    var ll = Number(lat).toFixed(5)+','+Number(lon).toFixed(5);
    return fetchJson('https://avwx.rest/api/metar/'+ll+'?nearest=true');
  }

  function parseSectorFromRaw(raw){
    var m = raw && raw.match(/(\d{3})V(\d{3})/);
    return m ? {from:parseInt(m[1],10), to:parseInt(m[2],10)} : null;
  }
  function parseVarSector(data){
    var from = data && data.variable_direction && typeof data.variable_direction.from==='number' ? data.variable_direction.from : null;
    var to   = data && data.variable_direction && typeof data.variable_direction.to==='number' ? data.variable_direction.to : null;
    if(typeof from==='number' && typeof to==='number') return {from:from, to:to};
    return parseSectorFromRaw(data && data.raw);
  }

  function applyMetar(side, data){
    var dirRepr = (data && data.wind_direction && data.wind_direction.repr ? String(data.wind_direction.repr) : '').toUpperCase();
    var dirVal  = data && data.wind_direction && typeof data.wind_direction.value==='number' ? data.wind_direction.value : null;
    var spdVal  = Math.max(0, Math.round(data && data.wind_speed && typeof data.wind_speed.value==='number' ? data.wind_speed.value : 0));
    var gustVal = Math.max(0, Math.round(data && data.wind_gust && typeof data.wind_gust.value==='number' ? data.wind_gust.value : 0));
    var oatVal  = Math.round(data && data.temperature && typeof data.temperature.value==='number' ? data.temperature.value : 15);
    var sector  = parseVarSector(data);

    var dirEl=document.getElementById(side+'WindDir');
    if(dirRepr==='VRB'){dirEl.value='VRB';}
    else if(dirVal!==null){dirEl.value=pad3(dirVal);}

    document.getElementById(side+'WindKt').value=String(spdVal);
    document.getElementById(side+'WindGust').value=String(gustVal||0);
    document.getElementById(side+'Oat').value=String(oatVal);

    if(sector){
      document.getElementById(side+'VrbFrom').value=pad3(sector.from);
      document.getElementById(side+'VrbTo').value=pad3(sector.to);
    } else {
      document.getElementById(side+'VrbFrom').value='';
      document.getElementById(side+'VrbTo').value='';
    }

    if(side==='dep') lastDepMetarRaw = (data && data.raw) ? data.raw : '—';
    else lastArrMetarRaw = (data && data.raw) ? data.raw : '—';

    updateWindDisplay(side);
  }

  async function loadMetarFor(side){
    var icao = (document.getElementById(side+'Icao').value||'').toUpperCase();
    var msgEl = document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent = 'Chargement METAR…';

    try{
      var station = await fetchStation(icao);
      var elevFt = station && typeof station.elevation_ft==='number' ? station.elevation_ft : null;
      var altInput = document.getElementById(side+'Alt');
      if (typeof elevFt === 'number' && elevFt > 0 && altInput) { altInput.value = String(Math.round(elevFt)); }

      var metar, usedIcao = icao, isNearest = false, distTxt = '';
      try{ metar = await fetchMetar(icao); }
      catch(_e){
        if(station && typeof station.latitude==='number' && typeof station.longitude==='number'){
          metar = await fetchNearestMetarByCoords(station.latitude, station.longitude);
          isNearest = true;
          usedIcao = (metar && (metar.station || metar.icao)) ? (metar.station || metar.icao) : usedIcao;
          var d = metar && metar.meta ? metar.meta.distance : null;
          var u = metar && metar.meta ? metar.meta.units : '';
          if(typeof d === 'number' && u){ distTxt = ' (~'+d+' '+u+')'; }
        }else{ throw _e; }
      }

      applyMetar(side, metar);
      var raw = metar && metar.raw ? metar.raw : '—';
      msgEl.textContent = isNearest
        ? 'METAR chargé (proche : '+usedIcao+distTxt+') : '+raw
        : 'METAR chargé : '+raw;

      updateWindDisplay(side);
    }catch(e){
      msgEl.textContent = 'METAR indisponible ('+((e && e.message) || 'erreur')+')';
    }
  }
  document.getElementById('btnDepMetar').addEventListener('click',function(){loadMetarFor('dep')});
  document.getElementById('btnArrMetar').addEventListener('click',function(){loadMetarFor('arr')});

  /* ===================== VRB : seulement multiples de 10 (010…360) ===================== */
  function MULTI10(v){ return v%10===0; }
  function format3(el){
    var v=(el.value||'').replace(/\D/g,'');
    if(!v){ el.value=''; return null; }
    var n=parseInt(v,10);
    if(!isFinite(n)) { el.value=''; return null; }
    n = Math.max(1, Math.min(360, n));
    el.value = pad3(n);
    return n;
  }
  function validateVrb(side){
    var fEl = document.getElementById(side+'VrbFrom'), tEl = document.getElementById(side+'VrbTo');
    fEl.classList.remove('invalid'); tEl.classList.remove('invalid');

    if(!fEl.value && !tEl.value) return true;

    var f = format3(fEl), t = format3(tEl);
    var ok = true;
    if(!f || !t) ok=false;
    if(ok && (!MULTI10(f) || !MULTI10(t))) ok=false;

    if(!ok){ fEl.classList.add('invalid'); tEl.classList.add('invalid'); }
    return ok;
  }

  /* ===================== COMPOSANTES & affichage ===================== */
  function dirForDisplay(dirField, sector){
    var t=(dirField||'').trim().toUpperCase();
    if(t==='VRB'){
      var f = format3(document.getElementById(sector.fromId));
      var to = format3(document.getElementById(sector.toId));
      if(!f || !to) return null;
      var a=f, b=to;
      var diff=((b-a+540)%360)-180;
      var mid=(a+diff/2+360)%360;
      if(mid===0) mid=360;
      return mid;
    }
    if(!t) return null;
    var n=parseInt(t.replace(/\D/g,''),10);
    if(isNaN(n)) return null;
    n=Math.max(1,Math.min(360,n));
    return n;
  }
  function compsFrom(qfuDisp, dirDisp, kt){
    if(qfuDisp===null || dirDisp===null) return null;
    var q = (qfuDisp%360);
    var d = (dirDisp%360);
    var ang=Math.abs(((d - q + 540) % 360) - 180);
    var hwSigned = kt * cosd(ang);
    var xw = Math.abs(kt * sind(ang));
    return { face: Math.max(0, hwSigned), tail: Math.max(0, -hwSigned), xw: xw, ang: ang };
  }

  function inSectorShortArc(angle, from, to){
    var span=((to-from+360)%360);
    var rel=((angle-from+360)%360);
    return rel<=span;
  }
  function worstXwindInSector(qfu, from, to, speed){
    var cand=[from%360, to%360, (qfu+90)%360, (qfu+270)%360];
    var seen={}, arr=[], i;
    for(i=0;i<cand.length;i++){ if(!seen[cand[i]]){seen[cand[i]]=1; arr.push(cand[i]);} }
    var max=0;
    for(i=0;i<arr.length;i++){
      var dir=arr[i];
      if(inSectorShortArc(dir, from%360, to%360)){
        var ang=Math.abs(((dir - (qfu%360) + 540)%360)-180);
        var xw=Math.abs(speed*sind(ang));
        if(xw>max) max=xw;
      }
    }
    return max;
  }

  function crosswindLimitColor(side, xwForColor){
    var card = document.getElementById(side+'XwCard');
    card.classList.remove('warn-yellow','warn-red');
    if(typeof xwForColor==='number'){
      if(xwForColor>=22){ card.classList.add('warn-red'); }
      else if(xwForColor>=18){ card.classList.add('warn-yellow'); }
    }
  }

  function updateCrosswindCell(side, qfu, dirDisp, kt){
    var xwElem = document.getElementById(side+'Xw');
    var gust = parseInt(document.getElementById(side+'WindGust').value||'0',10) || 0;
    var G = Math.max(kt, gust);

    var fEl=document.getElementById(side+'VrbFrom'), tEl=document.getElementById(side+'VrbTo');
    var hasSector = !!(fEl.value.trim() && tEl.value.trim()) && validateVrb(side);

    if(!qfu || !dirDisp || !kt){
      xwElem.textContent='—';
      crosswindLimitColor(side, null);
      return;
    }

    var mean = compsFrom(qfu, dirDisp, kt);
    var meanX = Math.round(mean.xw);

    if(hasSector){
      var f = parseInt(fEl.value,10), t = parseInt(tEl.value,10);
      var worstX = Math.round(worstXwindInSector(qfu, f, t, G));
      xwElem.innerHTML = meanX+' kt\n'+worstX+' kt sur '+pad3(f)+'V'+pad3(t);
      crosswindLimitColor(side, worstX);
    }else{
      xwElem.textContent = meanX+' kt';
      crosswindLimitColor(side, meanX);
    }
  }

  function updateWindDisplay(side){
    var qfu = normQFU(document.getElementById(side+'Qfu').value);
    var dirStr=(document.getElementById(side+'WindDir').value||'');
    var kt=parseInt(document.getElementById(side+'WindKt').value||'0',10)||0;
    var dirDisp = dirForDisplay(dirStr, {fromId:side+'VrbFrom', toId:side+'VrbTo'});

    if(qfu===null || dirDisp===null || !kt){
      document.getElementById(side+'HwFace').textContent='—';
      document.getElementById(side+'Xw').textContent='—';
      document.getElementById(side+'Tw').textContent='—';
      crosswindLimitColor(side,null);
      if(side==='dep'){ document.getElementById('todaMini').textContent=document.getElementById('depToda').value?document.getElementById('depToda').value+' m':'—'; }
      else{ document.getElementById('ldaMini').textContent=(document.getElementById('arrLda').value?document.getElementById('arrLda').value+' m':'—'); }
      return;
    }

    var c = compsFrom(qfu, dirDisp, kt);
    document.getElementById(side+'HwFace').textContent = Math.round(c.face);
    document.getElementById(side+'Tw').textContent     = Math.round(c.tail);

    updateCrosswindCell(side, qfu, dirDisp, kt);

    if(side==='dep'){ document.getElementById('todaMini').textContent=document.getElementById('depToda').value?document.getElementById('depToda').value+' m':'—'; }
    else{ document.getElementById('ldaMini').textContent=(document.getElementById('arrLda').value?document.getElementById('arrLda').value+' m':'—'); }
  }

  ;['depWindDir','arrWindDir','depWindKt','arrWindKt','depVrbFrom','arrVrbFrom','depVrbTo','arrVrbTo','depWindGust','arrWindGust','depOat','arrOat','depToda','arrLda','depQfu','arrQfu','depAlt','arrAlt','depTow','arrLdw','depExtraTO','arrExtraLDG']
    .forEach(function(id){
      document.getElementById(id).addEventListener('input',function(){updateWindDisplay(id.indexOf('dep')===0?'dep':'arr')});
      document.getElementById(id).addEventListener('blur',function(){
        if(id.indexOf('Vrb')>-1){ validateVrb(id.indexOf('dep')===0?'dep':'arr'); }
        if(id.slice(-7)==='WindDir'){
          var el=document.getElementById(id);
          var t=el.value.trim().toUpperCase();
          if(t && t!=='VRB'){ var n=parseInt(t.replace(/\D/g,''),10); if(!isNaN(n)){ n=Math.max(1,Math.min(360,n)); el.value=pad3(n);} }
        }
        updateWindDisplay(id.indexOf('dep')===0?'dep':'arr');
      });
    });

  /* ===================== Vent contraignant perfs ===================== */
  function sectorHasAngle(from,to,pred){
    var step=5, a=from%360, b=to%360;
    var span=((b-a+360)%360);
    for(var t=0;t<=span;t+=step){
      var d=(a+t)%360;
      if(pred(d)) return true;
    }
    return false;
  }
  function worstBetweenMeanAndSector(qfu, meanDirOrVRB, kt, gust, sectorFrom, sectorTo){
    var V=Math.max(0,kt|0), G=Math.max(V,gust|0);
    if(qfu===null) return {headwindForFactor:0, explain:'QFU manquant'};
    var q=(qfu%360);
    function comps(dir, speed){
      var d = Math.abs(((dir-q+540)%360)-180);
      var hwSigned = speed * Math.cos(toRad(d));
      var xw = Math.abs(speed * Math.sin(toRad(d)));
      return {d:d, hwSigned:hwSigned, xw:xw, dir:dir, speed:speed};
    }
    var candidates=[];
    var t=(meanDirOrVRB||'').trim().toUpperCase();
    if(t && t!=='VRB'){
      var n=parseInt(t.replace(/\D/g,''),10);
      if(!isNaN(n)){ n=Math.max(1,Math.min(360,n));
        var ang=Math.abs(((n-q+540)%360)-180);
        var sp = (ang>90)? G : V;
        candidates.push({src:'moyen', val:comps(n,sp)});
      }
    }
    if(sectorFrom && sectorTo){
      var from=sectorFrom%360, to=sectorTo%360;
      var dirs=[from,to,(from+(((to-from+360)%360)/2))%360,(q+180)%360,(q+90)%360,(q+270)%360];
      var seen={}, uniq=[], i;
      for(i=0;i<dirs.length;i++){ if(!seen[dirs[i]]){seen[dirs[i]]=1; uniq.push(dirs[i]);} }
      var hasTail = sectorHasAngle(from,to, function(a){ return Math.abs(((a-q+540)%360)-180) > 90; });
      for(i=0;i<uniq.length;i++){
        var d=uniq[i];
        var ang=Math.abs(((d-q+540)%360)-180);
        var sp = hasTail ? G : V;
        candidates.push({src:'secteur', val:comps(d,sp)});
      }
    }
    if(candidates.length===0){
      var c=comps((q+180)%360, G);
      return {headwindForFactor:c.hwSigned, explain:'VRB sans secteur : cas arrière à 180°'};
    }
    var worst=candidates[0].val;
    for(var j=1;j<candidates.length;j++){
      if(candidates[j].val.hwSigned < worst.hwSigned) worst=candidates[j].val;
    }
    return {headwindForFactor:worst.hwSigned, explain:'Règle vent appliquée (plus contraignant).'};
  }

  /* ===================== Facteurs perfs ===================== */
  function windDistanceFactor(head){
    if(head>=0){
      var pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}],x=Math.max(0,Math.min(30,head));
      if(x===0) return 1;
      for(var i=0;i<pts.length-1;i++){
        var p0=pts[i],p1=pts[i+1];
        if(x>=p0.x&&x<=p1.x) return p0.y+(p1.y-p0.y)*((x-p0.x)/(p1.x-p0.x));
      }
      return pts[pts.length-1].y;
    }else{
      var tw=Math.abs(head),steps=Math.ceil(tw/2);
      return 1+0.10*steps;
    }
  }

  /* ===================== Calculs ===================== */
  function setChip(el,state){el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');el.textContent=state==='ok'?'OK':'KO'}

  function ensureValidBeforeCompute(side){
    var ok = validateVrb(side);
    if(!ok){
      alert('Vérifier secteur variable vent');
      return false;
    }
    return true;
  }

  function interpTemp(rowTemps,arr,oat){
    var xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20],ys=arr;
    if(oat<=xs[0])return ys[0]; if(oat>=xs[2])return ys[2];
    if(oat<=xs[1])return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO_DR400(altFt,oat,massKg,surface,kind){
    var low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    var high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    var alpha=clamp01((massKg-700)/(900-700));
    function valAt(alt){
      var t=TO_DR400[alt];
      var v700=interpTemp(t.temps,t[surface].kg700[kind],oat);
      var v900=interpTemp(t.temps,t[surface].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    }
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG_DR400(altFt,oat,massKg,mode,kind){
    var low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    var high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    var alpha=clamp01((massKg-700)/(900-700));
    function valAt(alt){
      var t=LDG_DR400[alt];
      var v700=interpTemp(t.temps,t[mode].kg700[kind],oat);
      var v900=interpTemp(t.temps,t[mode].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    }
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpGridDR300(surface,kind,altFt,oat,massKg){
    var surf=TO_DR300[surface], temps=DR300_TEMPS, alts=surf.alts;
    function interpRow(row){
      var ys=row,x=oat;
      if(x<=temps[0])return ys[0]; if(x>=temps[3])return ys[3];
      if(x<=temps[1])return lerp(temps[0],ys[0],temps[1],ys[1],x);
      if(x<=temps[2])return lerp(temps[1],ys[1],temps[2],ys[2],x);
      return lerp(temps[2],ys[2],temps[3],ys[3],x);
    }
    var a0=alts[0], a1=alts[alts.length-1];
    for(var i=0;i<alts.length-1;i++){
      if(altFt<=alts[0]){a0=a1=alts[0];break;}
      if(altFt>=alts[alts.length-1]){a0=a1=alts[alts.length-1];break;}
      if(altFt>=alts[i] && altFt<=alts[i+1]){a0=alts[i];a1=alts[i+1];break;}
    }
    var idx0=alts.indexOf(a0), idx1=alts.indexOf(a1);
    var v0=interpRow(surf[kind][idx0]);
    var v1=interpRow(surf[kind][idx1]);
    var val=(a0===a1)?v0:lerp(a0,v0,a1,v1,altFt);
    return val*TO_DR300.massScale(massKg);
  }

  function computeDepPerf(){
    if(!ensureValidBeforeCompute('dep')) return;

    var qfu=normQFU(document.getElementById('depQfu').value);
    if(qfu===null){
      setChip(document.getElementById('toChip'),'neutral'); document.getElementById('toKpi').className='kpi';
      ['toBasePass','toBaseRoll','toWindF','toSpat','toExtra','toRes'].forEach(function(id){document.getElementById(id).textContent='—'});
      document.getElementById('toExplain').textContent=''; return;
    }
    var depAlt=+(document.getElementById('depAlt').value||0), depOat=+(document.getElementById('depOat').value||0),
        depExtra=+(document.getElementById('depExtraTO').value||1), depTow=+(document.getElementById('depTow').value||900),
        depToda=+(document.getElementById('depToda').value||0), safety=Math.max(0,+(document.getElementById('safety').value||30));

    var meanDir=document.getElementById('depWindDir').value;
    var kt=+(document.getElementById('depWindKt').value||0), gust=+(document.getElementById('depWindGust').value||0);
    var sf=parseInt(document.getElementById('depVrbFrom').value||'0',10), st=parseInt(document.getElementById('depVrbTo').value||'0',10);
    var w=worstBetweenMeanAndSector(qfu, meanDir, kt, gust, sf, st);

    var baseTO_pass, baseTO_roll;
    if(profile==='DR300'){
      baseTO_pass=interpGridDR300(depSurface,'pass',depAlt,depOat,depTow);
      baseTO_roll=interpGridDR300(depSurface,'roll',depAlt,depOat,depTow);
    }else{
      baseTO_pass=interpTO_DR400(depAlt,depOat,depTow,depSurface,'pass');
      baseTO_roll=interpTO_DR400(depAlt,depOat,depTow,depSurface,'roll');
    }

    var depWindF=windDistanceFactor(w.headwindForFactor||0);
    var spatsF=withSpats?1.00:1.03;
    var toCalc=Math.round(baseTO_pass*depWindF*depExtra*spatsF);
    var toMargin=Math.round(toCalc*(1+safety/100));

    document.getElementById('toBasePass').textContent=Math.round(baseTO_pass)+' m';
    document.getElementById('toBaseRoll').textContent=Math.round(baseTO_roll)+' m';
    document.getElementById('toWindF').textContent=depWindF.toFixed(2)+'×';
    document.getElementById('toSpat').textContent=(spatsF.toFixed(2)+'×')+(spatsF===1?' (carénages présents)':' (sans carénages)');
    document.getElementById('toExtra').textContent=depExtra.toFixed(2)+'×';
    document.getElementById('toRes').textContent=toCalc+' m';
    document.getElementById('todaMini').textContent=document.getElementById('depToda').value?document.getElementById('depToda').value+' m':'—';

    var stTO=(depToda? (toMargin<=depToda?'ok':'bad'):'neutral');
    setChip(document.getElementById('toChip'),stTO); document.getElementById('toKpi').className='kpi '+(stTO==='ok'?'ok':stTO==='bad'?'bad':'');
    document.getElementById('toKpiVal').textContent=toMargin+' m';

    document.getElementById('toExplain').textContent = '';
  }

  function computeArrPerf(){
    if(!ensureValidBeforeCompute('arr')) return;

    var qfu=normQFU(document.getElementById('arrQfu').value);
    if(qfu===null){
      setChip(document.getElementById('ldgChip'),'neutral'); document.getElementById('ldgKpi').className='kpi';
      ['ldgBasePass','ldgBaseRoll','ldgWindF','ldgExtra','ldgRes'].forEach(function(id){document.getElementById(id).textContent='—'});
      document.getElementById('ldgExplain').textContent=''; return;
    }
    var arrAlt=+(document.getElementById('arrAlt').value||0), arrOat=+(document.getElementById('arrOat').value||0),
        arrExtra=+(document.getElementById('arrExtraLDG').value||1), arrLdw=+(document.getElementById('arrLdw').value||900),
        arrLda=+(document.getElementById('arrLda').value||0), safety=Math.max(0,+(document.getElementById('safety').value||30));

    var meanDir=document.getElementById('arrWindDir').value;
    var kt=+(document.getElementById('arrWindKt').value||0), gust=+(document.getElementById('arrWindGust').value||0);
    var sf=parseInt(document.getElementById('arrVrbFrom').value||'0',10), st=parseInt(document.getElementById('arrVrbTo').value||'0',10);
    var w=worstBetweenMeanAndSector(qfu, meanDir, kt, gust, sf, st);

    var baseLDG_pass=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'pass');
    var baseLDG_roll=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'roll');
    var arrWindF=windDistanceFactor(w.headwindForFactor||0);
    var ldgCalc=Math.round(baseLDG_pass*arrWindF*arrExtra);
    var ldgMargin=Math.round(ldgCalc*(1+safety/100));

    document.getElementById('ldgBasePass').textContent=Math.round(baseLDG_pass)+' m';
    document.getElementById('ldgBaseRoll').textContent=Math.round(baseLDG_roll)+' m';
    document.getElementById('ldgWindF').textContent=arrWindF.toFixed(2)+'×';
    document.getElementById('ldgExtra').textContent=arrExtra.toFixed(2)+'×';
    document.getElementById('ldgRes').textContent=ldgCalc+' m';
    document.getElementById('ldaMini').textContent=document.getElementById('arrLda').value?document.getElementById('arrLda').value+' m':'—';

    var stLDG=(arrLda? (ldgMargin<=arrLda?'ok':'bad'):'neutral');
    setChip(document.getElementById('ldgChip'),stLDG); document.getElementById('ldgKpi').className='kpi '+(stLDG==='ok'?'ok':stLDG==='bad'?'bad':'');
    document.getElementById('ldgKpiVal').textContent=ldgMargin+' m';

    document.getElementById('ldgExplain').textContent = '';
  }

  document.getElementById('btnCalcDep').addEventListener('click', computeDepPerf);
  document.getElementById('btnCalcArr').addEventListener('click', computeArrPerf);

  /* ===================== Impression — 2 pages propres + xwind séparé ===================== */
  function nowStamp(){
    var d = new Date();
    var dd = String(d.getDate()).padStart(2,'0');
    var mm = String(d.getMonth()+1).padStart(2,'0');
    var yyyy = d.getFullYear();
    var hh = String(d.getHours()).padStart(2,'0');
    var mi = String(d.getMinutes()).padStart(2,'0');
    return 'Imprimé le '+dd+'/'+mm+'/'+yyyy+' à '+hh+':'+mi;
  }

  function buildCompsFor(side){
    var qfu = normQFU(document.getElementById(side+'Qfu').value);
    var dirStr=(document.getElementById(side+'WindDir').value||'');
    var kt=parseInt(document.getElementById(side+'WindKt').value||'0',10)||0;
    var gust=parseInt(document.getElementById(side+'WindGust').value||'0',10)||0;
    var dirDisp = dirForDisplay(dirStr, {fromId:side+'VrbFrom', toId:side+'VrbTo'});
    var fEl=document.getElementById(side+'VrbFrom'), tEl=document.getElementById(side+'VrbTo');
    var hasSector = !!(fEl.value.trim() && tEl.value.trim()) && validateVrb(side);

    if(qfu===null || dirDisp===null || !kt){
      return {face:'—', tail:'—', meanX:'—', worstX:null, worstLabel:''};
    }
    var comp = compsFrom(qfu, dirDisp, kt);
    var meanX = Math.round(comp.xw);
    var face = Math.round(comp.face);
    var tail = Math.round(comp.tail);

    var out = {face:face, tail:tail, meanX:meanX, worstX:null, worstLabel:''};
    if(hasSector){
      var f = parseInt(fEl.value,10), t = parseInt(tEl.value,10);
      var G = Math.max(kt, gust);
      var worst = Math.round(worstXwindInSector(qfu, f, t, G));
      out.worstX = worst;
      out.worstLabel = pad3(f)+'V'+pad3(t);
    }
    return out;
  }

  function sectionTerrainHTML(title, side, comps){
    var icao=(document.getElementById(side+'Icao').value||'').toUpperCase();
    var qfu=(document.getElementById(side+'Qfu').value||'').padStart(3,'0');
    var alt=document.getElementById(side+'Alt').value||'—';
    var oat=document.getElementById(side+'Oat').value||'—';
    var lenLabel = side==='dep' ? 'TODA' : 'LDA';
    var lenVal = document.getElementById(side+(side==='dep'?'Toda':'Lda')).value || '—';
    var dir=(document.getElementById(side+'WindDir').value||'').toUpperCase();
    var spd=document.getElementById(side+'WindKt').value||'0';
    var gst=document.getElementById(side+'WindGust').value||'0';
    var metar = side==='dep' ? (window.lastDepMetarRaw||'—') : (window.lastArrMetarRaw||'—');

    // Composantes lisibles (séparées)
    var xwindBlock = `Travers moyen : ${comps.meanX} kt`;
    if(comps.worstX!==null){
      xwindBlock += `\nTravers max secteur ${comps.worstLabel} : ${comps.worstX} kt`;
    }

    return `
      <div class="section">
        <span class="ptitle">${title}</span>
        <div class="kv" style="margin-top:6px">
          <div class="k">ICAO</div><div class="v">${icao}</div>
          <div class="k">QFU</div><div class="v">${qfu}°</div>
          <div class="k">Élévation</div><div class="v">${alt} ft</div>
          <div class="k">OAT</div><div class="v">${oat} °C</div>
          <div class="k">${lenLabel}</div><div class="v">${lenVal} m</div>
        </div>
        <div class="subgrid" style="margin-top:6px">
          <div>
            <div class="k">Vent</div>
            <div class="v">${dir} / ${spd} kt (G${gst})</div>
          </div>
          <div>
            <div class="k">Composantes</div>
            <div class="v">Face ${comps.face} kt · Arrière ${comps.tail} kt</div>
            <div class="v" style="margin-top:4px; white-space:pre-line">${xwindBlock}</div>
          </div>
        </div>
        <div style="margin-top:6px">
          <div class="k">METAR brut</div>
          <div class="metar">${(metar||'—').replace(/</g,'&lt;')}</div>
        </div>
      </div>
    `;
  }

  function sectionPerfHTML(title, side){
    var req = side==='dep' ? (document.getElementById('toKpiVal').textContent||'—')
                           : (document.getElementById('ldgKpiVal').textContent||'—');
    var avail = side==='dep' ? (document.getElementById('todaMini').textContent||'—')
                             : (document.getElementById('ldaMini').textContent||'—');
    var roll = side==='dep' ? (document.getElementById('toBaseRoll').textContent||'—')
                            : (document.getElementById('ldgBaseRoll').textContent||'—');
    var pass = side==='dep' ? (document.getElementById('toBasePass').textContent||'—')
                            : (document.getElementById('ldgBasePass').textContent||'—');
    var windF = side==='dep' ? (document.getElementById('toWindF').textContent||'—')
                             : (document.getElementById('ldgWindF').textContent||'—');
    var extra = side==='dep' ? (document.getElementById('toExtra').textContent||'—')
                             : (document.getElementById('ldgExtra').textContent||'—');
    var spat  = side==='dep' ? (document.getElementById('toSpat').textContent||'') : '';

    return `
      <div class="section">
        <span class="ptitle">${title}</span>
        <div class="kv" style="margin-top:6px">
          <div class="k">Requis (marge incluse)</div><div class="v b">${req}</div>
          <div class="k">${side==='dep'?'TODA dispo':'LDA dispo'}</div><div class="v">${avail}</div>
          <div class="k">Roulement (sans marge)</div><div class="v">${roll}</div>
          <div class="k">Passage 15 m (sans marge)</div><div class="v">${pass}</div>
          <div class="k">Facteur vent</div><div class="v">${windF}</div>
          ${ side==='dep' ? `<div class="k">Carénages</div><div class="v">${spat}</div>` : '' }
          <div class="k">Facteur supplémentaire</div><div class="v">${extra}</div>
        </div>
      </div>
    `;
  }

  function buildPrintHTML(){
    var safety=Math.max(0,+(document.getElementById('safety').value||30));
    var aircraft=document.getElementById('aircraftSel').value;
    var prop=document.getElementById('propeller').value;
    var spats=document.getElementById('spatsWith').classList.contains('on')?'Avec carénages':'Sans carénages (+3% TO)';
    var profileTxt = window.profile;

    var compsDep = buildCompsFor('dep');
    var compsArr = buildCompsFor('arr');

    const page1 = `
      <div class="page">
        <div class="section">
          <span class="ptitle">CALCULCATEUR DE PERFORMANCES</span>
          <div style="margin-top:4px; color:#374151">${nowStamp()}</div>
        </div>

        <div class="section">
          <span class="ptitle">Paramètres généraux</span>
          <div class="kv" style="margin-top:6px">
            <div class="k">Avion</div><div class="v">${aircraft}</div>
            <div class="k">Hélice</div><div class="v">${prop}</div>
            <div class="k">Profil</div><div class="v">${profileTxt}</div>
            <div class="k">Marge sécurité</div><div class="v">${safety} %</div>
            <div class="k">Carénages</div><div class="v">${spats}</div>
          </div>
        </div>

        ${sectionTerrainHTML('Terrain de départ', 'dep', compsDep)}
        ${sectionPerfHTML('Décollage — Résultats', 'dep')}
      </div>
    `;

    const page2 = `
      <div class="page">
        ${sectionTerrainHTML('Terrain d’arrivée', 'arr', compsArr)}
        ${sectionPerfHTML('Atterrissage — Résultats', 'arr')}
      </div>
    `;

    return page1 + page2;
  }

  document.getElementById('btnPrint').addEventListener('click',function(){
    document.getElementById('rawPre').innerHTML = buildPrintHTML();
    window.print();
  });

  // init
  (function init(){
    var ac=$('#aircraftSel').value; $('#propeller').value=propByAircraft[ac]||'';
    updateWindDisplay('dep'); updateWindDisplay('arr'); updateResLabels();
  })();
</script>
</body>
</html>
