<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULATEUR DE PERFORMANCES</title>

  <!-- BULMA -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

  <!-- Overrides / styles spÃ©cifiques (KPI + impression + 2-3 ajustements) -->
  <style>
    :root{
      --ok:#16a34a;
      --bad:#dc2626;
      --warn-yellow-bg:#fff7ed; --warn-yellow-border:#fbbf24;
      --warn-red-bg:#fef2f2; --warn-red-border:#ef4444;
    }

    /* Espacements un peu plus "aÃ©rÃ©s" */
    .section { padding-top: 1.25rem; padding-bottom: 1.25rem; }

    /* Petits textes */
    .note{font-size:12px}
    .mini-note{font-size:11px}

    /* KPI */
    .kpi{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid #dbdbdb;border-radius:16px;padding:14px 16px;margin:8px 0;
      background:#fff;
    }
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:#6b7280;letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:#6b7280}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}

    /* Chips (statuts) */
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid #dbdbdb;font-weight:800;
      background:#f5f5f5; color:#363636;
      white-space:nowrap;
    }
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f5f5f5;color:#363636;border-color:#dbdbdb}

    /* Petites "cases" de rÃ©sultat (vent face/travers/arriÃ¨re + dÃ©tails) */
    .fieldbox{
      border:1px solid #dbdbdb;border-radius:12px;background:#fafafa;padding:10px;
    }
    .fieldbox .k{font-size:12px;color:#6b7280}
    .fieldbox .v{margin-top:4px;font-weight:600;white-space:pre-line}

    /* Avertissements / invalid */
    .warn-yellow{background:var(--warn-yellow-bg)!important;border-color:var(--warn-yellow-border)!important}
    .warn-red{background:var(--warn-red-bg)!important;border-color:var(--warn-red-border)!important}
    .invalid{border-color:var(--bad)!important}

    /* Impression */
    #printRaw{display:none}
    .printWrap{
      color:#000;
      font:11pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .ptitle{
      background:#000; color:#fff; padding:8px 12px; border-radius:12px;
      display:inline-block; font-weight:700; margin:2mm 0 4mm 0;
    }
    .sectionPrint{margin:4mm 0}
    .kv{display:grid;grid-template-columns:42% 58%;gap:4px 8px;align-items:baseline}
    .kv .k{color:#374151}
    .kv .v{font-weight:600}
    .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px}
    .metar{
      background:#f7f7f7;border:1px solid #ddd;border-radius:8px;padding:8px;white-space:pre-wrap;word-break:break-word;font-size:10pt;
    }
    .b{font-weight:700}
    .page{page-break-after:always}
    .page:last-child{page-break-after:auto}

    @media print{
      @page { size: A4; margin: 12mm; }
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:0}
      body{background:#fff}
    }
  </style>
</head>

<body>
  <div id="appRoot">
    <!-- Bandeau -->
    <section class="hero is-link">
      <div class="hero-body">
        <div class="container">
          <h1 class="title has-text-centered">CALCULATEUR DE PERFORMANCES</h1>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="container">

        <!-- ParamÃ¨tres gÃ©nÃ©raux -->
        <div class="box">
          <h2 class="title is-5 has-text-centered">ParamÃ¨tres gÃ©nÃ©raux</h2>

          <div class="columns is-multiline">
            <div class="column is-6">
              <div class="field">
                <label class="label">Avion</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="aircraftSel">
                      <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
                      <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
                      <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
                      <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
                      <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
                      <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">HÃ©lice</label>
                <div class="control">
                  <input id="propeller" class="input" value="Sensenich" readonly />
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">Marge sÃ©curitÃ© (%)</label>
                <div class="control">
                  <input id="safety" class="input" type="number" inputmode="numeric" value="30" min="0"/>
                </div>
              </div>
            </div>

            <div class="column is-6">
              <div class="field">
                <label class="label">&nbsp;</label>
                <div class="control">
                  <button id="btnPrint" class="button is-light is-fullwidth has-text-weight-bold">Imprimer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2 colonnes (dep/arr) -->
        <div class="columns is-variable is-4 is-multiline">

          <!-- DÃ©part -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardDep">
              <h2 class="title is-5 has-text-centered">Terrain de dÃ©part</h2>

              <div class="columns is-mobile is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">ICAO dÃ©part</label>
                    <div class="control">
                      <input id="depIcao" class="input" inputmode="latin" maxlength="4" placeholder="LFxx" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Ã‰lÃ©vation (ft)</label>
                    <div class="control">
                      <input id="depAlt" class="input" type="number" inputmode="numeric" min="0" step="10" value="0" />
                    </div>
                  </div>
                </div>

                <div class="column is-4 is-flex is-align-items-flex-end">
                  <button id="btnDepMetar" class="button is-info is-fullwidth has-text-weight-bold is-small">Charger METAR</button>
                </div>
              </div>

              <div id="depMetarMsg" class="has-text-grey note"></div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">QFU dÃ©part (Â°)</label>
                    <div class="control">
                      <input id="depQfu" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001â€“360"/>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">TODA (m)</label>
                    <div class="control">
                      <input id="depToda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">ASDA (m)</label>
                    <div class="control">
                      <input id="depAsda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent â€” Direction (Â° ou "VRB")</label>
                    <div class="control">
                      <input id="depWindDir" class="input" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent â€” Vitesse (kt)</label>
                    <div class="control">
                      <input id="depWindKt" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Rafales (kt)</label>
                    <div class="control">
                      <input id="depWindGust" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-8">
                  <div class="field">
                    <label class="label">Secteur VRB (optionnel)</label>
                    <div class="control">
                      <div class="columns is-mobile is-variable is-1">
                        <div class="column">
                          <input id="depVrbFrom" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
                        </div>
                        <div class="column is-narrow is-flex is-align-items-center has-text-weight-bold has-text-grey">
                          V
                        </div>
                        <div class="column">
                          <input id="depVrbTo" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">OAT (Â°C)</label>
                    <div class="control">
                      <input id="depOat" class="input" type="number" inputmode="numeric" value="15"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent de face</div>
                    <div class="v"><span id="depHwFace">â€”</span> kt</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div id="depXwCard" class="fieldbox">
                    <div class="k">Vent de travers</div>
                    <div class="v" id="depXw">â€”</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent arriÃ¨re</div>
                    <div class="v"><span id="depTw">â€”</span> kt</div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field has-text-centered">
                    <label class="label">CarÃ©nages de roues</label>
                    <div class="buttons is-centered">
                      <button id="spatsWith" class="button is-link is-light">Avec</button>
                      <button id="spatsWithout" class="button is-light">Sans</button>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field has-text-centered">
                    <label class="label">Surface piste</label>
                    <div class="buttons is-centered">
                      <button id="depSurfHard" class="button is-link is-light">Dur</button>
                      <button id="depSurfGrass" class="button is-success is-light">Herbe</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">Masse au dÃ©collage (kg)</label>
                    <div class="control">
                      <input id="depTow" class="input" type="number" inputmode="numeric" value="900"/>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field">
                    <label class="label">Facteur suppl. dÃ©collage</label>
                    <div class="control">
                      <input id="depExtraTO" class="input" type="number" inputmode="numeric" step="0.01" value="1.00"/>
                    </div>
                  </div>
                </div>
              </div>

              <button id="btnCalcDep" class="button is-link is-fullwidth mt-3">Calculer les performances dÃ©collage</button>
            </div>
          </div>

          <!-- DÃ©collage perf -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardDepPerf">
              <div class="is-flex is-justify-content-space-between is-align-items-center">
                <h2 class="title is-5 has-text-centered" style="flex:1">DÃ©collage : performances calculÃ©es</h2>
                <span id="toChip" class="chip neutral">â€”</span>
              </div>

              <div id="toKpi" class="kpi">
                <div class="left">
                  <span class="title">Requis (marge incluse)</span>
                  <span class="value" id="toKpiVal">â€” m</span>
                  <span class="sub">TODA dispo : <span id="todaMini">â€”</span></span>
                </div>
              </div>

              <div class="columns is-multiline is-variable is-2">
                <div class="column is-6"><div class="fieldbox"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur vent</div><div id="toWindF" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">CarÃ©nages</div><div id="toSpat" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur supplÃ©mentaire</div><div id="toExtra" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k" id="toResLabel">RÃ©sultat</div><div id="toRes" class="v">â€”</div></div></div>
              </div>

              <div id="toExplain" class="has-text-grey mini-note"></div>
            </div>
          </div>

          <!-- ArrivÃ©e -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardArr">
              <h2 class="title is-5 has-text-centered">Terrain d'arrivÃ©e</h2>

              <div class="columns is-mobile is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">ICAO arrivÃ©e</label>
                    <div class="control">
                      <input id="arrIcao" class="input" inputmode="latin" maxlength="4" placeholder="LFxx" />
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">Ã‰lÃ©vation (ft)</label>
                    <div class="control">
                      <input id="arrAlt" class="input" type="number" inputmode="numeric" min="0" step="10" value="0" />
                    </div>
                  </div>
                </div>

                <div class="column is-4 is-flex is-align-items-flex-end">
                  <button id="btnArrMetar" class="button is-info is-fullwidth has-text-weight-bold is-small">Charger METAR</button>
                </div>
              </div>

              <div id="arrMetarMsg" class="has-text-grey note"></div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">QFU arrivÃ©e (Â°)</label>
                    <div class="control">
                      <input id="arrQfu" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="001â€“360"/>
                    </div>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">LDA (m)</label>
                    <div class="control">
                      <input id="arrLda" class="input" type="text" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent â€” Direction (Â° ou "VRB")</label>
                    <div class="control">
                      <input id="arrWindDir" class="input" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
                    </div>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Vent â€” Vitesse (kt)</label>
                    <div class="control">
                      <input id="arrWindKt" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field">
                    <label class="label">Rafales (kt)</label>
                    <div class="control">
                      <input id="arrWindGust" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-8">
                  <div class="field">
                    <label class="label">Secteur VRB (optionnel)</label>
                    <div class="control">
                      <div class="columns is-mobile is-variable is-1">
                        <div class="column">
                          <input id="arrVrbFrom" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
                        </div>
                        <div class="column is-narrow is-flex is-align-items-center has-text-weight-bold has-text-grey">
                          V
                        </div>
                        <div class="column">
                          <input id="arrVrbTo" class="input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="field">
                    <label class="label">OAT (Â°C)</label>
                    <div class="control">
                      <input id="arrOat" class="input" type="number" inputmode="numeric" value="15"/>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent de face</div>
                    <div class="v"><span id="arrHwFace">â€”</span> kt</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div id="arrXwCard" class="fieldbox">
                    <div class="k">Vent de travers</div>
                    <div class="v" id="arrXw">â€”</div>
                  </div>
                </div>

                <div class="column is-4">
                  <div class="fieldbox">
                    <div class="k">Vent arriÃ¨re</div>
                    <div class="v"><span id="arrTw">â€”</span> kt</div>
                  </div>
                </div>
              </div>

              <div class="field has-text-centered">
                <label class="label">Type de freinage</label>
                <div class="buttons is-centered">
                  <button id="arrModerate" class="button is-link is-light">Freinage modÃ©rÃ© (dur/herbe)</button>
                  <button id="arrNoBrake" class="button is-success is-light">Sans frein sur herbe</button>
                </div>
              </div>

              <div class="columns is-variable is-2">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">Masse Ã  l'atterrissage (kg)</label>
                    <div class="control">
                      <input id="arrLdw" class="input" type="number" inputmode="numeric" value="900"/>
                    </div>
                  </div>
                </div>

                <div class="column is-6">
                  <div class="field">
                    <label class="label">Facteur suppl. atterrissage</label>
                    <div class="control">
                      <input id="arrExtraLDG" class="input" type="number" inputmode="numeric" step="0.01" value="1.00"/>
                    </div>
                  </div>
                </div>
              </div>

              <button id="btnCalcArr" class="button is-link is-fullwidth mt-3">Calculer les performances atterrissage</button>
            </div>
          </div>

          <!-- Atterrissage perf -->
          <div class="column is-12-tablet is-6-desktop">
            <div class="box" id="cardArrPerf">
              <div class="is-flex is-justify-content-space-between is-align-items-center">
                <h2 class="title is-5 has-text-centered" style="flex:1">Atterrissage : performances calculÃ©es</h2>
                <span id="ldgChip" class="chip neutral">â€”</span>
              </div>

              <div id="ldgKpi" class="kpi">
                <div class="left">
                  <span class="title">Requis (marge incluse)</span>
                  <span class="value" id="ldgKpiVal">â€” m</span>
                  <span class="sub">LDA dispo : <span id="ldaMini">â€”</span></span>
                </div>
              </div>

              <div class="columns is-multiline is-variable is-2">
                <div class="column is-6"><div class="fieldbox"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">â€”</div></div></div>
                <div class="column is-6"><div class="fieldbox"><div class="k">Facteur supplÃ©mentaire</div><div id="ldgExtra" class="v">â€”</div></div></div>
                <div class="column is-12"><div class="fieldbox"><div class="k" id="ldgResLabel">RÃ©sultat</div><div id="ldgRes" class="v">â€”</div></div></div>
              </div>

              <div id="ldgExplain" class="has-text-grey mini-note"></div>
            </div>
          </div>

        </div>

        <!-- CrÃ©dits -->
        <p class="has-text-grey has-text-centered" style="font-size:11px">
          <span>Source : Manuel de vol respectif de chaque avion - AÃ©roclub de Beauvais-TillÃ©</span><br>
          <span>DÃ©veloppÃ© par Hugo DERUELLE avec l'aide de l'IA</span>
        </p>

      </div>
    </section>
  </div>

  <datalist id="dirOptions"><option value="VRB"></option></datalist>

  <!-- Impression -->
  <section id="printRaw"><div id="rawPre" class="printWrap"></div></section>

  <script>

  /* ===================== DONNÃ‰ES ===================== */
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,485,540]},kg900:{roll:[460,530,615],pass:[800,905,1025]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},hard:{kg700:{roll:[235,265,300],pass:[500,560,620]},kg900:{roll:[425,475,535],pass:[890,1000,1125]}},grass:{kg700:{roll:[330,380,440],pass:[595,675,760]},kg900:{roll:[700,820,960],pass:[1165,1350,1550]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},moderate:{kg700:{roll:[145,155,165],pass:[365,385,400]},kg900:{roll:[185,200,210],pass:[435,460,485]}},nobrake_grass:{kg700:{roll:[215,230,250],pass:[435,460,485]},kg900:{roll:[280,300,325],pass:[530,560,590]} }},4000:{temps:{minus20:-13,isa:7,plus20:27},moderate:{kg700:{roll:[160,175,185],pass:[395,420,440]},kg900:{roll:[205,225,240],pass:[475,505,535]}},nobrake_grass:{kg700:{roll:[240,260,285],pass:[475,505,530]},kg900:{roll:[310,335,360],pass:[580,615,655]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},moderate:{kg700:{roll:[180,195,210],pass:[430,460,485]},kg900:{roll:[235,250,270],pass:[525,555,590]}},nobrake_grass:{kg700:{roll:[275,290,315],pass:[525,555,590]},kg900:{roll:[350,375,405],pass:[640,680,725]}}}};
  const DR300_TEMPS=[0,15,30,45];
  const TO_DR300 = {
    hard: { alts:[0,1500,3000,4500],
      roll: [[315,350,390,430],[330,360,400,460],[385,430,475,520],[430,480,520,560]],
      pass: [[530,590,655,720],[605,675,745,820],[685,765,845,920],[760,845,935,1020]],
    },
    grass: { alts:[0,1500,3000,4600],
      roll: [[380,420,470,515],[420,470,515,575],[455,510,570,625],[510,575,635,695]],
      pass: [[595,660,735,805],[675,745,820,895],[760,850,935,1025],[845,940,1040,1135]],
    },
    massScale: function(m){ return Math.min(1, m/1000); }
  };

  /* ===================== UTILITAIRES ===================== */
  var $=function(s){return document.querySelector(s)};
  function lerp(x0,y0,x1,y1,x){ return y0 + (y1-y0)*((x-x0)/(x1-x0 || 1)); }
  function pad3(n){ return String(Math.round(n)).padStart(3,'0'); }
  function clamp01(v){ return Math.max(0,Math.min(1,v)); }
  function toRad(d){ return d*Math.PI/180; }
  function cosd(d){ return Math.cos(toRad(d)); }
  function sind(d){ return Math.sin(toRad(d)); }

  /* ===================== Ã‰TAT / UI ===================== */
  var landingMode='moderate', withSpats=true, profile='DR400', depSurface='hard';
  var lastDepMetarRaw='â€”', lastArrMetarRaw='â€”';

  var propByAircraft={'F-GCAL (120cv)':'Sensenich','F-BXEK (120cv)':'Sensenich','F-BTKG (120cv)':'Sensenich','F-BTXS (120cv)':'Sensenich','F-BTBS (120cv)':'Mac Cauley','F-BTBJ (108cv)':'Mac Cauley'};
  $('#aircraftSel').addEventListener('change', function(){
    var ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    profile=(ac.indexOf('F-BTKG')===0 || ac.indexOf('F-BTXS')===0)?'DR300':'DR400';
    updateWindDisplay('dep'); updateWindDisplay('arr');
  });

  // carÃ©nages / surfaces / freinage
  $('#spatsWith').onclick=function(){withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');};
  $('#spatsWithout').onclick=function(){withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');};
  $('#depSurfHard').onclick=function(){depSurface='hard';$('#depSurfHard').classList.add('on');$('#depSurfGrass').classList.remove('on');};
  $('#depSurfGrass').onclick=function(){depSurface='grass';$('#depSurfGrass').classList.add('on');$('#depSurfHard').classList.remove('on');};
  $('#arrModerate').onclick=function(){landingMode='moderate';$('#arrModerate').classList.add('on');$('#arrNoBrake').classList.remove('on');};
  $('#arrNoBrake').onclick=function(){landingMode='nobrake_grass';$('#arrNoBrake').classList.add('on');$('#arrModerate').classList.remove('on');};

  // safety
  function updateResLabels(){
    var s = Math.max(0, parseFloat($('#safety').value||'0')||0);
    $('#safety').value = String(s);
  }
  $('#safety').addEventListener('input', updateResLabels); updateResLabels();

  function sanitizeIcao(el){ el.value=(el.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,4) }
  ;['depIcao','arrIcao'].forEach(function(id){
    var el=$('#'+id);
    el.addEventListener('input',function(){sanitizeIcao(el)});
    el.addEventListener('blur',function(){sanitizeIcao(el)});
  });

  // QFU
  function normQFU(val){ var n=parseInt(String(val).replace(/\D/g,''),10); if(isNaN(n)) return null; n=Math.max(1,Math.min(360,n)); return n; }
  function display3(n){ return n===null?'':pad3(n); }
  ;['depQfu','arrQfu'].forEach(function(id){
    var el=$('#'+id);
    el.addEventListener('blur',function(){ var n=normQFU(el.value); el.value=display3(n); updateWindDisplay(id.indexOf('dep')===0?'dep':'arr'); });
    el.addEventListener('input',function(){ updateWindDisplay(id.indexOf('dep')===0?'dep':'arr'); });
  });

  // TODA/LDA
  $('#depToda').addEventListener('input',function(){ var s=$('#depToda').value.replace(/\D/g,''); if(s==='') return; var v=parseInt(s,10); if(!isFinite(v)||v<0)v=0; $('#depToda').value=String(v); });
  $('#arrLda').addEventListener('input',function(){ var s=$('#arrLda').value.replace(/\D/g,'').slice(0,4); $('#arrLda').value=s; });

  /* ===================== METAR (AVWX) ===================== */
  var AVWX_TOKEN='GJ6qEqUaMvA3LtaeCjdhgYJTTT4TuvUXxv_I8WF0340';
  function fetchJson(url){
    return fetch(url, { headers:{ Authorization:'Bearer '+AVWX_TOKEN, Accept:'application/json' } })
      .then(function(resp){ if(!resp.ok) throw new Error('HTTP '+resp.status); return resp.json(); });
  }
  function fetchMetar(icao){ return fetchJson('https://avwx.rest/api/metar/'+icao); }
  function fetchStation(icao){ return fetchJson('https://avwx.rest/api/station/'+icao); }
  function fetchNearestMetarByCoords(lat, lon){
    var ll = Number(lat).toFixed(5)+','+Number(lon).toFixed(5);
    return fetchJson('https://avwx.rest/api/metar/'+ll+'?nearest=true');
  }

  function parseSectorFromRaw(raw){
    var m = raw && raw.match(/(\d{3})V(\d{3})/);
    return m ? {from:parseInt(m[1],10), to:parseInt(m[2],10)} : null;
  }
  function parseVarSector(data){
    var from = data && data.variable_direction && typeof data.variable_direction.from==='number' ? data.variable_direction.from : null;
    var to   = data && data.variable_direction && typeof data.variable_direction.to==='number' ? data.variable_direction.to : null;
    if(typeof from==='number' && typeof to==='number') return {from:from, to:to};
    return parseSectorFromRaw(data && data.raw);
  }

  function applyMetar(side, data){
    var dirRepr = (data && data.wind_direction && data.wind_direction.repr ? String(data.wind_direction.repr) : '').toUpperCase();
    var dirVal  = data && data.wind_direction && typeof data.wind_direction.value==='number' ? data.wind_direction.value : null;
    var spdVal  = Math.max(0, Math.round(data && data.wind_speed && typeof data.wind_speed.value==='number' ? data.wind_speed.value : 0));
    var gustVal = Math.max(0, Math.round(data && data.wind_gust && typeof data.wind_gust.value==='number' ? data.wind_gust.value : 0));
    var oatVal  = Math.round(data && data.temperature && typeof data.temperature.value==='number' ? data.temperature.value : 15);
    var sector  = parseVarSector(data);

    var dirEl=document.getElementById(side+'WindDir');
    if(dirRepr==='VRB'){dirEl.value='VRB';}
    else if(dirVal!==null){dirEl.value=pad3(dirVal);}

    document.getElementById(side+'WindKt').value=String(spdVal);
    document.getElementById(side+'WindGust').value=String(gustVal||0);
    document.getElementById(side+'Oat').value=String(oatVal);

    if(sector){
      document.getElementById(side+'VrbFrom').value=pad3(sector.from);
      document.getElementById(side+'VrbTo').value=pad3(sector.to);
    } else {
      document.getElementById(side+'VrbFrom').value='';
      document.getElementById(side+'VrbTo').value='';
    }

    if(side==='dep') lastDepMetarRaw = (data && data.raw) ? data.raw : 'â€”';
    else lastArrMetarRaw = (data && data.raw) ? data.raw : 'â€”';

  // --- Ajout : prise en compte du TEMPO ---
// On rÃ©cupÃ¨re la direction du QFU si dispo
const qfu = normQFU(document.getElementById(side + 'Qfu').value);
if (data && data.remarks && typeof data.remarks === "string" && qfu) {
  const tempoMatch = data.remarks.match(/TEMPO\s+(\d{3}|VRB)(\d{2,3})G?(\d{2,3})?/);
  if (tempoMatch) {
    const tempoDir = tempoMatch[1].toUpperCase();
    const tempoSpd = parseInt(tempoMatch[2] || "0", 10);
    const tempoGst = parseInt(tempoMatch[3] || tempoMatch[2] || "0", 10);

    const curDir = document.getElementById(side + 'WindDir').value;
    const curSpd = parseInt(document.getElementById(side + 'WindKt').value || '0', 10);
    const curGst = parseInt(document.getElementById(side + 'WindGust').value || '0', 10);

    const curComp = compsFrom(qfu, parseInt(curDir), Math.max(curSpd, curGst));
    const tempoComp = compsFrom(qfu, parseInt(tempoDir), Math.max(tempoSpd, tempoGst));

    // Si le tempo a plus de vent arriÃ¨re ou travers que le vent moyen â†’ on remplace
    const tempoIsWorse =
      tempoComp.tail > curComp.tail ||
      tempoComp.xw > curComp.xw;

    if (tempoIsWorse) {
      document.getElementById(side + 'WindDir').value =
        tempoDir === 'VRB' ? 'VRB' : pad3(parseInt(tempoDir, 10));
      document.getElementById(side + 'WindKt').value = String(tempoSpd);
      document.getElementById(side + 'WindGust').value = String(tempoGst || 0);
      document.getElementById(side + 'VrbFrom').value = '';
      document.getElementById(side + 'VrbTo').value = '';
    }
  }
}

// --- fin ajout TEMPO ---

    updateWindDisplay(side);
  }

  async function loadMetarFor(side){
    var icao = (document.getElementById(side+'Icao').value||'').toUpperCase();
    var msgEl = document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent = 'Chargement METARâ€¦';

    try{
      var station = await fetchStation(icao);
      var elevFt = station && typeof station.elevation_ft==='number' ? station.elevation_ft : null;
      var altInput = document.getElementById(side+'Alt');
      if (typeof elevFt === 'number' && elevFt > 0 && altInput) { altInput.value = String(Math.round(elevFt)); }

      var metar, usedIcao = icao, isNearest = false, distTxt = '';
      try{ metar = await fetchMetar(icao); }
      catch(_e){
        if(station && typeof station.latitude==='number' && typeof station.longitude==='number'){
          metar = await fetchNearestMetarByCoords(station.latitude, station.longitude);
          isNearest = true;
          usedIcao = (metar && (metar.station || metar.icao)) ? (metar.station || metar.icao) : usedIcao;
          var d = metar && metar.meta ? metar.meta.distance : null;
          var u = metar && metar.meta ? metar.meta.units : '';
          if(typeof d === 'number' && u){ distTxt = ' (~'+d+' '+u+')'; }
        }else{ throw _e; }
      }

      applyMetar(side, metar);
      var raw = metar && metar.raw ? metar.raw : 'â€”';
      msgEl.textContent = isNearest
        ? 'METAR chargÃ© (proche : '+usedIcao+distTxt+') : '+raw
        : 'METAR chargÃ© : '+raw;

      updateWindDisplay(side);
    }catch(e){
      msgEl.textContent = 'METAR indisponible ('+((e && e.message) || 'erreur')+')';
    }
  }
  document.getElementById('btnDepMetar').addEventListener('click',function(){loadMetarFor('dep')});
  document.getElementById('btnArrMetar').addEventListener('click',function(){loadMetarFor('arr')});

  /* ===================== VRB : seulement multiples de 10 (010â€¦360) ===================== */
  function MULTI10(v){ return v%10===0; }
  function format3(el){
    var v=(el.value||'').replace(/\D/g,'');
    if(!v){ el.value=''; return null; }
    var n=parseInt(v,10);
    if(!isFinite(n)) { el.value=''; return null; }
    n = Math.max(1, Math.min(360, n));
    el.value = pad3(n);
    return n;
  }
  function validateVrb(side){
    var fEl = document.getElementById(side+'VrbFrom'), tEl = document.getElementById(side+'VrbTo');
    fEl.classList.remove('invalid'); tEl.classList.remove('invalid');

    if(!fEl.value && !tEl.value) return true;

    var f = format3(fEl), t = format3(tEl);
    var ok = true;
    if(!f || !t) ok=false;
    if(ok && (!MULTI10(f) || !MULTI10(t))) ok=false;

    if(!ok){ fEl.classList.add('invalid'); tEl.classList.add('invalid'); }
    return ok;
  }

  // === DÃ©clenche recalcul du vent quand on modifie manuellement les champs ===
['dep', 'arr'].forEach(side => {
  ['WindDir', 'WindKt', 'WindGust', 'VrbFrom', 'VrbTo'].forEach(suffix => {
    const el = document.getElementById(side + suffix);
    if (el) {
      el.addEventListener('input', () => updateWindDisplay(side));
      el.addEventListener('blur', () => updateWindDisplay(side));
    }
  });
});


  /* ===================== COMPOSANTES & affichage ===================== */
  function dirForDisplay(dirField, sector){
    var t=(dirField||'').trim().toUpperCase();
    if(t==='VRB'){
      var f = format3(document.getElementById(sector.fromId));
      var to = format3(document.getElementById(sector.toId));
      if(!f || !to) return null;
      var a=f, b=to;
      var diff=((b-a+540)%360)-180;
      var mid=(a+diff/2+360)%360;
      if(mid===0) mid=360;
      return mid;
    }
    if(!t) return null;
    var n=parseInt(t.replace(/\D/g,''),10);
    if(isNaN(n)) return null;
    n=Math.max(1,Math.min(360,n));
    return n;
  }
  function compsFrom(qfuDisp, dirDisp, kt){
    if(qfuDisp===null || dirDisp===null) return null;
    var q = (qfuDisp%360);
    var d = (dirDisp%360);
    var ang=Math.abs(((d - q + 540) % 360) - 180);
    var hwSigned = kt * cosd(ang);
    var xw = Math.abs(kt * sind(ang));
    return { face: Math.max(0, hwSigned), tail: Math.max(0, -hwSigned), xw: xw, ang: ang };
  }

  function inSectorShortArc(angle, from, to){
    var span=((to-from+360)%360);
    var rel=((angle-from+360)%360);
    return rel<=span;
  }
  function worstXwindInSector(qfu, from, to, speed){
    var cand=[from%360, to%360, (qfu+90)%360, (qfu+270)%360];
    var seen={}, arr=[], i;
    for(i=0;i<cand.length;i++){ if(!seen[cand[i]]){seen[cand[i]]=1; arr.push(cand[i]);} }
    var max=0;
    for(i=0;i<arr.length;i++){
      var dir=arr[i];
      if(inSectorShortArc(dir, from%360, to%360)){
        var ang=Math.abs(((dir - (qfu%360) + 540)%360)-180);
        var xw=Math.abs(speed*sind(ang));
        if(xw>max) max=xw;
      }
    }
    return max;
  }

  function crosswindLimitColor(side, xwForColor){
    var card = document.getElementById(side+'XwCard');
    card.classList.remove('warn-yellow','warn-red');
    if(typeof xwForColor==='number'){
      if(xwForColor>=22){ card.classList.add('warn-red'); }
      else if(xwForColor>=18){ card.classList.add('warn-yellow'); }
    }
  }

  function updateCrosswindCell(side, qfu, dirDisp, kt){
    var xwElem = document.getElementById(side+'Xw');
    var gust = parseInt(document.getElementById(side+'WindGust').value||'0',10) || 0;
    var G = Math.max(kt, gust);

    var fEl=document.getElementById(side+'VrbFrom'), tEl=document.getElementById(side+'VrbTo');
    var hasSector = !!(fEl.value.trim() && tEl.value.trim()) && validateVrb(side);

    if(!qfu || !dirDisp || !kt){
      xwElem.textContent='â€”';
      crosswindLimitColor(side, null);
      return;
    }

    var mean = compsFrom(qfu, dirDisp, kt);
    var meanX = Math.round(mean.xw);

    if(hasSector){
      var f = parseInt(fEl.value,10), t = parseInt(tEl.value,10);
      var worstX = Math.round(worstXwindInSector(qfu, f, t, G));
      xwElem.innerHTML = meanX+' kt\n'+worstX+' kt sur '+pad3(f)+'V'+pad3(t);
      crosswindLimitColor(side, worstX);
    }else{
      xwElem.textContent = meanX+' kt';
      crosswindLimitColor(side, meanX);
    }
  }

function updateWindDisplay(side) {
  var qfu = normQFU(document.getElementById(side + 'Qfu').value);
  var dirStr = (document.getElementById(side + 'WindDir').value || '');
  var kt = parseInt(document.getElementById(side + 'WindKt').value || '0', 10) || 0;
  var gust = parseInt(document.getElementById(side + 'WindGust').value || '0', 10) || 0;
  var dirDisp = dirForDisplay(dirStr, { fromId: side + 'VrbFrom', toId: side + 'VrbTo' });

  // === Si donnÃ©es manquantes ===
  if (qfu === null || (!dirDisp && dirStr.trim().toUpperCase() !== 'VRB') || !kt) {
    document.getElementById(side + 'HwFace').textContent = 'â€”';
    document.getElementById(side + 'Xw').textContent = 'â€”';
    document.getElementById(side + 'Tw').textContent = 'â€”';
    crosswindLimitColor(side, null);

    if (side === 'dep') {
      document.getElementById('todaMini').textContent = document.getElementById('depToda').value
        ? document.getElementById('depToda').value + ' m' : 'â€”';
    } else {
      document.getElementById('ldaMini').textContent = document.getElementById('arrLda').value
        ? document.getElementById('arrLda').value + ' m' : 'â€”';
    }

    // ðŸŸ¢ Forcer affichage du â€œâ€” ktâ€ quand aucune donnÃ©e
    ["HwFace", "Tw", "Xw"].forEach(suffix => {
      const el = document.getElementById(side + suffix);
      if (!el) return;
      const parent = el.closest(".v");
      const val = el.textContent.replace(/[\s\n\r]+/g, '').trim();
      if (val === "" || val === "â€”") {
        parent.innerHTML = `<span id="${side + suffix}">â€”</span> kt`;
      }
    });

    return;
  }

  // ==== Calcul du vent le plus contraignant ====
  var sf = parseInt(document.getElementById(side + 'VrbFrom').value || '0', 10);
  var st = parseInt(document.getElementById(side + 'VrbTo').value || '0', 10);
  var w = worstBetweenMeanAndSector(qfu, dirStr, kt, gust, sf, st);

  // === Composantes ===
  document.getElementById(side + 'HwFace').textContent = Math.round(Math.max(0, w.headwindForFactor));
  document.getElementById(side + 'Tw').textContent = Math.round(Math.max(0, -w.headwindForFactor));

  // === Vent de travers ===
  var xwElem = document.getElementById(side + 'Xw');
  var fEl = document.getElementById(side + 'VrbFrom');
  var tEl = document.getElementById(side + 'VrbTo');
  var G = Math.max(kt, gust);
  var cMean = compsFrom(qfu, dirDisp, kt);
  var cGust = compsFrom(qfu, dirDisp, G);
  var worstX = Math.round(Math.max(cMean.xw, cGust.xw));
  var baseText = `${worstX} kt`;

  var hasSector = false, f = null, t = null;
  if (fEl.value.trim() && tEl.value.trim() && validateVrb(side)) {
    f = parseInt(fEl.value, 10);
    t = parseInt(tEl.value, 10);
    hasSector = true;
  }

  if (hasSector) {
    var step = 5;
    var worst = { type: '', val: 0, dir: f };
    for (var d = f; (d - t + 360) % 360 >= 0 ? d <= t : (d + 360) % 360 <= (t + 360) % 360; d = (d + step) % 360) {
      var c = compsFrom(qfu, d, G);
      var absTail = Math.max(c.tail, 0);
      var absFace = Math.max(c.face, 0);
      var absX = c.xw;
      if (absTail > worst.val) worst = { type: 'arriÃ¨re', val: absTail, dir: d };
      else if (absTail === 0 && absX > worst.val) worst = { type: 'travers', val: absX, dir: d };
    }

    xwElem.innerHTML =
      baseText + '\n' +
      `+${Math.round(worst.val)} kt ${worst.type} (${pad3(worst.dir)}Â°) sur ${pad3(f)}V${pad3(t)}`;

    crosswindLimitColor(side, worst.val);
  } else {
    xwElem.textContent = baseText;
    crosswindLimitColor(side, worstX);
  }

  // === Mise Ã  jour TODA/LDA ===
  if (side === 'dep') {
    document.getElementById('todaMini').textContent = document.getElementById('depToda').value
      ? document.getElementById('depToda').value + ' m' : 'â€”';
  } else {
    document.getElementById('ldaMini').textContent = document.getElementById('arrLda').value
      ? document.getElementById('arrLda').value + ' m' : 'â€”';
  }

  // === Afficher â€œâ€” ktâ€ si vide aprÃ¨s calcul
  ["HwFace", "Tw", "Xw"].forEach(suffix => {
    const el = document.getElementById(side + suffix);
    if (!el) return;
    const parent = el.closest(".v");
    const val = el.textContent.replace(/[\s\n\r]+/g, '').trim();
    if (val === "" || val === "â€”") {
      parent.innerHTML = `<span id="${side + suffix}">â€”</span> kt`;
    }
  });
}

  /* ===================== Vent contraignant perfs ===================== */
  function sectorHasAngle(from,to,pred){
    var step=5, a=from%360, b=to%360;
    var span=((b-a+360)%360);
    for(var t=0;t<=span;t+=step){
      var d=(a+t)%360;
      if(pred(d)) return true;
    }
    return false;
  }
function worstBetweenMeanAndSector(qfu, meanDirOrVRB, kt, gust, sectorFrom, sectorTo) {
  const V = Math.max(0, kt | 0);
  const G = Math.max(V, gust | 0);
  if (qfu === null) return { headwindForFactor: 0, explain: 'QFU manquant' };
  const q = qfu % 360;

  // calcule les composantes face / travers / arriÃ¨re
  function comps(dir, speed) {
    const d = Math.abs(((dir - q + 540) % 360) - 180);
    const hwSigned = speed * Math.cos(toRad(d)); // positif face, nÃ©gatif arriÃ¨re
    const xw = Math.abs(speed * Math.sin(toRad(d)));
    return { d, hwSigned, xw, dir, speed };
  }

  const candidates = [];
  const t = (meanDirOrVRB || '').trim().toUpperCase();

  // ===== Cas vent moyen =====
  if (t && t !== 'VRB') {
    const n = parseInt(t.replace(/\D/g, ''), 10);
    if (!isNaN(n)) {
      const dir = Math.max(1, Math.min(360, n));
      const cMean = comps(dir, V);
      const cGust = comps(dir, G);

      // Analyse dÃ©taillÃ©e de la rafale : on garde la composante la plus pÃ©nalisante
      const worstHeadwind = Math.min(cMean.hwSigned, cGust.hwSigned);
      const worstCrosswind = Math.max(cMean.xw, cGust.xw);
      const final = {
        hwSigned: worstHeadwind,
        xw: worstCrosswind,
        dir,
        d: cMean.d
      };
      candidates.push(final);
    }
  }

  // ===== Cas secteur variable =====
  if (sectorFrom && sectorTo) {
    const from = sectorFrom % 360, to = sectorTo % 360;
    // on prend des directions reprÃ©sentatives du secteur
    const dirs = [from, to, (from + (((to - from + 360) % 360) / 2)) % 360];
    for (const d of dirs) {
      const cVrbMean = comps(d, V);
      const cVrbGust = comps(d, G);
      const worstHeadwind = Math.min(cVrbMean.hwSigned, cVrbGust.hwSigned);
      const worstCrosswind = Math.max(cVrbMean.xw, cVrbGust.xw);
      const final = {
        hwSigned: worstHeadwind,
        xw: worstCrosswind,
        dir: d,
        d: cVrbMean.d
      };
      candidates.push(final);
    }
  }

  // ===== SÃ©lection du plus contraignant =====
  let worst = candidates[0] || comps((q + 180) % 360, G);
  for (let i = 1; i < candidates.length; i++) {
    const c = candidates[i];
    // prioritÃ© : le plus de vent arriÃ¨re, sinon le plus de travers
    if (c.hwSigned < worst.hwSigned || c.xw > worst.xw) worst = c;
  }

  return {
    headwindForFactor: worst.hwSigned,
    crosswindForColor: worst.xw,
    explain: 'Vent le plus contraignant retenu (rafale partielle incluse si dÃ©favorable).'
  };
}


  /* ===================== Facteurs perfs ===================== */
  function windDistanceFactor(head){
    if(head>=0){
      var pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}],x=Math.max(0,Math.min(30,head));
      if(x===0) return 1;
      for(var i=0;i<pts.length-1;i++){
        var p0=pts[i],p1=pts[i+1];
        if(x>=p0.x&&x<=p1.x) return p0.y+(p1.y-p0.y)*((x-p0.x)/(p1.x-p0.x));
      }
      return pts[pts.length-1].y;
    }else{
      var tw=Math.abs(head),steps=Math.ceil(tw/2);
      return 1+0.10*steps;
    }
  }

  /* ===================== Calculs ===================== */
  function setChip(el,state){el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');el.textContent=state==='ok'?'OK':'KO'}

  function ensureValidBeforeCompute(side){
    var ok = validateVrb(side);
    if(!ok){
      alert('VÃ©rifier secteur variable vent');
      return false;
    }
    return true;
  }

  function interpTemp(rowTemps,arr,oat){
    var xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20],ys=arr;
    if(oat<=xs[0])return ys[0]; if(oat>=xs[2])return ys[2];
    if(oat<=xs[1])return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO_DR400(altFt,oat,massKg,surface,kind){
    var low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    var high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    var alpha=clamp01((massKg-700)/(900-700));
    function valAt(alt){
      var t=TO_DR400[alt];
      var v700=interpTemp(t.temps,t[surface].kg700[kind],oat);
      var v900=interpTemp(t.temps,t[surface].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    }
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG_DR400(altFt,oat,massKg,mode,kind){
    var low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    var high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    var alpha=clamp01((massKg-700)/(900-700));
    function valAt(alt){
      var t=LDG_DR400[alt];
      var v700=interpTemp(t.temps,t[mode].kg700[kind],oat);
      var v900=interpTemp(t.temps,t[mode].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    }
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpGridDR300(surface,kind,altFt,oat,massKg){
    var surf=TO_DR300[surface], temps=DR300_TEMPS, alts=surf.alts;
    function interpRow(row){
      var ys=row,x=oat;
      if(x<=temps[0])return ys[0]; if(x>=temps[3])return ys[3];
      if(x<=temps[1])return lerp(temps[0],ys[0],temps[1],ys[1],x);
      if(x<=temps[2])return lerp(temps[1],ys[1],temps[2],ys[2],x);
      return lerp(temps[2],ys[2],temps[3],ys[3],x);
    }
    var a0=alts[0], a1=alts[alts.length-1];
    for(var i=0;i<alts.length-1;i++){
      if(altFt<=alts[0]){a0=a1=alts[0];break;}
      if(altFt>=alts[alts.length-1]){a0=a1=alts[alts.length-1];break;}
      if(altFt>=alts[i] && altFt<=alts[i+1]){a0=alts[i];a1=alts[i+1];break;}
    }
    var idx0=alts.indexOf(a0), idx1=alts.indexOf(a1);
    var v0=interpRow(surf[kind][idx0]);
    var v1=interpRow(surf[kind][idx1]);
    var val=(a0===a1)?v0:lerp(a0,v0,a1,v1,altFt);
    return val*TO_DR300.massScale(massKg);
  }

  function computeDepPerf(){
    if(!ensureValidBeforeCompute('dep')) return;

    var qfu=normQFU(document.getElementById('depQfu').value);
    if(qfu===null){
      setChip(document.getElementById('toChip'),'neutral'); document.getElementById('toKpi').className='kpi';
      ['toBasePass','toBaseRoll','toWindF','toSpat','toExtra','toRes'].forEach(function(id){document.getElementById(id).textContent='â€”'});
      document.getElementById('toExplain').textContent=''; return;
    }
    var depAlt=+(document.getElementById('depAlt').value||0), depOat=+(document.getElementById('depOat').value||0),
        depExtra=+(document.getElementById('depExtraTO').value||1), depTow=+(document.getElementById('depTow').value||900),
        depToda=+(document.getElementById('depToda').value||0), safety=Math.max(0,+(document.getElementById('safety').value||30));

    var meanDir=document.getElementById('depWindDir').value;
    var kt=+(document.getElementById('depWindKt').value||0), gust=+(document.getElementById('depWindGust').value||0);
    var sf=parseInt(document.getElementById('depVrbFrom').value||'0',10), st=parseInt(document.getElementById('depVrbTo').value||'0',10);
    var w=worstBetweenMeanAndSector(qfu, meanDir, kt, gust, sf, st);

    var baseTO_pass, baseTO_roll;
    if(profile==='DR300'){
      baseTO_pass=interpGridDR300(depSurface,'pass',depAlt,depOat,depTow);
      baseTO_roll=interpGridDR300(depSurface,'roll',depAlt,depOat,depTow);
    }else{
      baseTO_pass=interpTO_DR400(depAlt,depOat,depTow,depSurface,'pass');
      baseTO_roll=interpTO_DR400(depAlt,depOat,depTow,depSurface,'roll');
    }

    var depWindF=windDistanceFactor(w.headwindForFactor||0);
    var spatsF=withSpats?1.00:1.03;
    var toCalc=Math.round(baseTO_pass*depWindF*depExtra*spatsF);
    var toMargin=Math.round(toCalc*(1+safety/100));

    document.getElementById('toBasePass').textContent=Math.round(baseTO_pass)+' m';
    document.getElementById('toBaseRoll').textContent=Math.round(baseTO_roll)+' m';
    document.getElementById('toWindF').textContent=depWindF.toFixed(2)+'Ã—';
    document.getElementById('toSpat').textContent=(spatsF.toFixed(2)+'Ã—')+(spatsF===1?' (carÃ©nages prÃ©sents)':' (sans carÃ©nages)');
    document.getElementById('toExtra').textContent=depExtra.toFixed(2)+'Ã—';
    document.getElementById('toRes').textContent=toCalc+' m';
    document.getElementById('todaMini').textContent=document.getElementById('depToda').value?document.getElementById('depToda').value+' m':'â€”';

    var stTO=(depToda? (toMargin<=depToda?'ok':'bad'):'neutral');
    setChip(document.getElementById('toChip'),stTO); document.getElementById('toKpi').className='kpi '+(stTO==='ok'?'ok':stTO==='bad'?'bad':'');
    document.getElementById('toKpiVal').textContent=toMargin+' m';

    document.getElementById('toExplain').textContent = 'Vent utilisÃ© pour les calculs : le plus contraignant (moyen, rafales, secteur variable, TEMPO).';
  }

  function computeArrPerf(){
    if(!ensureValidBeforeCompute('arr')) return;

    var qfu=normQFU(document.getElementById('arrQfu').value);
    if(qfu===null){
      setChip(document.getElementById('ldgChip'),'neutral'); document.getElementById('ldgKpi').className='kpi';
      ['ldgBasePass','ldgBaseRoll','ldgWindF','ldgExtra','ldgRes'].forEach(function(id){document.getElementById(id).textContent='â€”'});
      document.getElementById('ldgExplain').textContent=''; return;
    }
    var arrAlt=+(document.getElementById('arrAlt').value||0), arrOat=+(document.getElementById('arrOat').value||0),
        arrExtra=+(document.getElementById('arrExtraLDG').value||1), arrLdw=+(document.getElementById('arrLdw').value||900),
        arrLda=+(document.getElementById('arrLda').value||0), safety=Math.max(0,+(document.getElementById('safety').value||30));

    var meanDir=document.getElementById('arrWindDir').value;
    var kt=+(document.getElementById('arrWindKt').value||0), gust=+(document.getElementById('arrWindGust').value||0);
    var sf=parseInt(document.getElementById('arrVrbFrom').value||'0',10), st=parseInt(document.getElementById('arrVrbTo').value||'0',10);
    var w=worstBetweenMeanAndSector(qfu, meanDir, kt, gust, sf, st);

    var baseLDG_pass=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'pass');
    var baseLDG_roll=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'roll');
    var arrWindF=windDistanceFactor(w.headwindForFactor||0);
    var ldgCalc=Math.round(baseLDG_pass*arrWindF*arrExtra);
    var ldgMargin=Math.round(ldgCalc*(1+safety/100));

    document.getElementById('ldgBasePass').textContent=Math.round(baseLDG_pass)+' m';
    document.getElementById('ldgBaseRoll').textContent=Math.round(baseLDG_roll)+' m';
    document.getElementById('ldgWindF').textContent=arrWindF.toFixed(2)+'Ã—';
    document.getElementById('ldgExtra').textContent=arrExtra.toFixed(2)+'Ã—';
    document.getElementById('ldgRes').textContent=ldgCalc+' m';
    document.getElementById('ldaMini').textContent=document.getElementById('arrLda').value?document.getElementById('arrLda').value+' m':'â€”';

    var stLDG=(arrLda? (ldgMargin<=arrLda?'ok':'bad'):'neutral');
    setChip(document.getElementById('ldgChip'),stLDG); document.getElementById('ldgKpi').className='kpi '+(stLDG==='ok'?'ok':stLDG==='bad'?'bad':'');
    document.getElementById('ldgKpiVal').textContent=ldgMargin+' m';

    document.getElementById('ldgExplain').textContent = 'Vent utilisÃ© pour les calculs : le plus contraignant (moyen, rafales, secteur variable, TEMPO).';
  }

  document.getElementById('btnCalcDep').addEventListener('click', computeDepPerf);
  document.getElementById('btnCalcArr').addEventListener('click', computeArrPerf);

  /* ===================== Impression â€” 2 pages propres + xwind sÃ©parÃ© ===================== */
  function nowStamp(){
    var d = new Date();
    var dd = String(d.getDate()).padStart(2,'0');
    var mm = String(d.getMonth()+1).padStart(2,'0');
    var yyyy = d.getFullYear();
    var hh = String(d.getHours()).padStart(2,'0');
    var mi = String(d.getMinutes()).padStart(2,'0');
    return 'ImprimÃ© le '+dd+'/'+mm+'/'+yyyy+' Ã  '+hh+':'+mi;
  }

  function buildCompsFor(side){
    var qfu = normQFU(document.getElementById(side+'Qfu').value);
    var dirStr=(document.getElementById(side+'WindDir').value||'');
    var kt=parseInt(document.getElementById(side+'WindKt').value||'0',10)||0;
    var gust=parseInt(document.getElementById(side+'WindGust').value||'0',10)||0;
    var dirDisp = dirForDisplay(dirStr, {fromId:side+'VrbFrom', toId:side+'VrbTo'});
    var fEl=document.getElementById(side+'VrbFrom'), tEl=document.getElementById(side+'VrbTo');
    var hasSector = !!(fEl.value.trim() && tEl.value.trim()) && validateVrb(side);

    if(qfu===null || dirDisp===null || !kt){
      return {face:'â€”', tail:'â€”', meanX:'â€”', worstX:null, worstLabel:''};
    }
    var comp = compsFrom(qfu, dirDisp, kt);
    var meanX = Math.round(comp.xw);
    var face = Math.round(comp.face);
    var tail = Math.round(comp.tail);

    var out = {face:face, tail:tail, meanX:meanX, worstX:null, worstLabel:''};
    if(hasSector){
      var f = parseInt(fEl.value,10), t = parseInt(tEl.value,10);
      var G = Math.max(kt, gust);
      var worst = Math.round(worstXwindInSector(qfu, f, t, G));
      out.worstX = worst;
      out.worstLabel = pad3(f)+'V'+pad3(t);
    }
    return out;
  }

  function sectionTerrainHTML(title, side, comps){
    var icao=(document.getElementById(side+'Icao').value||'').toUpperCase();
    var qfu=(document.getElementById(side+'Qfu').value||'').padStart(3,'0');
    var alt=document.getElementById(side+'Alt').value||'â€”';
    var oat=document.getElementById(side+'Oat').value||'â€”';
    var lenLabel = side==='dep' ? 'TODA' : 'LDA';
    var lenVal = document.getElementById(side+(side==='dep'?'Toda':'Lda')).value || 'â€”';
    var dir=(document.getElementById(side+'WindDir').value||'').toUpperCase();
    var spd=document.getElementById(side+'WindKt').value||'0';
    var gst=document.getElementById(side+'WindGust').value||'0';
    var metar = side==='dep' ? (window.lastDepMetarRaw||'â€”') : (window.lastArrMetarRaw||'â€”');

    // Composantes lisibles (sÃ©parÃ©es)
    var xwindBlock = `Travers moyen : ${comps.meanX} kt`;
    if(comps.worstX!==null){
      xwindBlock += `\nTravers max secteur ${comps.worstLabel} : ${comps.worstX} kt`;
    }

    return `
      <div class="section">
        <span class="ptitle">${title}</span>
        <div class="kv" style="margin-top:6px">
          <div class="k">ICAO</div><div class="v">${icao}</div>
          <div class="k">QFU</div><div class="v">${qfu}Â°</div>
          <div class="k">Ã‰lÃ©vation</div><div class="v">${alt} ft</div>
          <div class="k">OAT</div><div class="v">${oat} Â°C</div>
          <div class="k">${lenLabel}</div><div class="v">${lenVal} m</div>
        </div>
        <div class="subgrid" style="margin-top:6px">
          <div>
            <div class="k">Vent</div>
            <div class="v">${dir} / ${spd} kt (G${gst})</div>
          </div>
          <div>
            <div class="k">Composantes</div>
            <div class="v">Face ${comps.face} kt Â· ArriÃ¨re ${comps.tail} kt</div>
            <div class="v" style="margin-top:4px; white-space:pre-line">${xwindBlock}</div>
          </div>
        </div>
        <div style="margin-top:6px">
          <div class="k">METAR brut</div>
          <div class="metar">${(metar||'â€”').replace(/</g,'&lt;')}</div>
        </div>
      </div>
    `;
  }

  function sectionPerfHTML(title, side){
    var req = side==='dep' ? (document.getElementById('toKpiVal').textContent||'â€”')
                           : (document.getElementById('ldgKpiVal').textContent||'â€”');
    var avail = side==='dep' ? (document.getElementById('todaMini').textContent||'â€”')
                             : (document.getElementById('ldaMini').textContent||'â€”');
    var roll = side==='dep' ? (document.getElementById('toBaseRoll').textContent||'â€”')
                            : (document.getElementById('ldgBaseRoll').textContent||'â€”');
    var pass = side==='dep' ? (document.getElementById('toBasePass').textContent||'â€”')
                            : (document.getElementById('ldgBasePass').textContent||'â€”');
    var windF = side==='dep' ? (document.getElementById('toWindF').textContent||'â€”')
                             : (document.getElementById('ldgWindF').textContent||'â€”');
    var extra = side==='dep' ? (document.getElementById('toExtra').textContent||'â€”')
                             : (document.getElementById('ldgExtra').textContent||'â€”');
    var spat  = side==='dep' ? (document.getElementById('toSpat').textContent||'') : '';

    return `
      <div class="section">
        <span class="ptitle">${title}</span>
        <div class="kv" style="margin-top:6px">
          <div class="k">Requis (marge incluse)</div><div class="v b">${req}</div>
          <div class="k">${side==='dep'?'TODA dispo':'LDA dispo'}</div><div class="v">${avail}</div>
          <div class="k">Roulement (sans marge)</div><div class="v">${roll}</div>
          <div class="k">Passage 15 m (sans marge)</div><div class="v">${pass}</div>
          <div class="k">Facteur vent</div><div class="v">${windF}</div>
          ${ side==='dep' ? `<div class="k">CarÃ©nages</div><div class="v">${spat}</div>` : '' }
          <div class="k">Facteur supplÃ©mentaire</div><div class="v">${extra}</div>
        </div>
      </div>
    `;
  }

  function buildPrintHTML(){
    var safety=Math.max(0,+(document.getElementById('safety').value||30));
    var aircraft=document.getElementById('aircraftSel').value;
    var prop=document.getElementById('propeller').value;
    var spats=document.getElementById('spatsWith').classList.contains('on')?'Avec carÃ©nages':'Sans carÃ©nages (+3% TO)';
    var profileTxt = window.profile;

    var compsDep = buildCompsFor('dep');
    var compsArr = buildCompsFor('arr');

    const page1 = `
      <div class="page">
        <div class="section">
          <span class="ptitle">CALCULCATEUR DE PERFORMANCES</span>
          <div style="margin-top:4px; color:#374151">${nowStamp()}</div>
        </div>

        <div class="section">
          <span class="ptitle">ParamÃ¨tres gÃ©nÃ©raux</span>
          <div class="kv" style="margin-top:6px">
            <div class="k">Avion</div><div class="v">${aircraft}</div>
            <div class="k">HÃ©lice</div><div class="v">${prop}</div>
            <div class="k">Profil</div><div class="v">${profileTxtupdateWindDisplay(side)}</div>
            <div class="k">Marge sÃ©curitÃ©</div><div class="v">${safety} %</div>
            <div class="k">CarÃ©nages</div><div class="v">${spats}</div>
          </div>
        </div>

        ${sectionTerrainHTML('Terrain de dÃ©part', 'dep', compsDep)}
        ${sectionPerfHTML('DÃ©collage â€” RÃ©sultats', 'dep')}
      </div>
    `;

    const page2 = `
      <div class="page">
        ${sectionTerrainHTML('Terrain dâ€™arrivÃ©e', 'arr', compsArr)}
        ${sectionPerfHTML('Atterrissage â€” RÃ©sultats', 'arr')}
      </div>
    `;

    return page1 + page2;
  }

  document.getElementById('btnPrint').addEventListener('click',function(){
    document.getElementById('rawPre').innerHTML = buildPrintHTML();
    window.print();
  });

  // init
  (function init(){
    var ac=$('#aircraftSel').value; $('#propeller').value=propByAircraft[ac]||'';
    updateWindDisplay('dep'); updateWindDisplay('arr'); updateResLabels();
  })();
</script>
</body>
</html>
